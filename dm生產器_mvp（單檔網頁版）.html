<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DM ç”Ÿç”¢å™¨ MVP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script>
    // å‚™ç”¨QRCodeåº«è¼‰å…¥
    window.addEventListener('load', function() {
      if (typeof QRCode === 'undefined') {
        console.log('å˜—è©¦è¼‰å…¥å‚™ç”¨QRCodeåº«...');
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js';
        script.onload = function() {
          console.log('å‚™ç”¨QRCodeåº«è¼‰å…¥æˆåŠŸ');
          // å¦‚æœè¼‰å…¥çš„æ˜¯qrcode-generatorï¼Œéœ€è¦é©é…API
          if (typeof qrcode !== 'undefined') {
            window.QRCode = {
              toCanvas: function(canvas, text, options) {
                return new Promise((resolve, reject) => {
                  try {
                    const qr = qrcode(0, 'M');
                    qr.addData(text);
                    qr.make();
                    const ctx = canvas.getContext('2d');
                    const size = options.width || 300;
                    canvas.width = size;
                    canvas.height = size;
                    const cellSize = size / qr.getModuleCount();
                    for (let row = 0; row < qr.getModuleCount(); row++) {
                      for (let col = 0; col < qr.getModuleCount(); col++) {
                        ctx.fillStyle = qr.isDark(row, col) ? '#000000' : '#ffffff';
                        ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                      }
                    }
                    resolve();
                  } catch (e) {
                    reject(e);
                  }
                });
              }
            };
          }
        };
        script.onerror = function() {
          console.error('æ‰€æœ‰QRCodeåº«è¼‰å…¥å¤±æ•—');
        };
        document.head.appendChild(script);
      } else {
        console.log('QRCodeåº«è¼‰å…¥æˆåŠŸ');
      }
    });
  </script>
  <style>
    :root { --dm-w: 1080px; --dm-h: 1350px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    #dm-canvas { width: var(--dm-w); min-height: var(--dm-h); height: auto; overflow: visible; }
    /* ç¢ºä¿è¼¸å‡ºæ™‚æ’ç‰ˆç©©å®š */
    .dm-page { width: 1080px; height: 1350px; margin: 0 auto 32px; display: block; position: relative; }
    #scale-wrap { transform-origin: top left; }
    .ellipsis-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .ellipsis-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    /* å„ªåŒ–å°åœ–ç‰‡æ¸…æ™°åº¦ */
    .high-res-img { 
      image-rendering: -webkit-optimize-contrast; 
      image-rendering: crisp-edges; 
      image-rendering: pixelated;
      transform: translateZ(0);
      backface-visibility: hidden;
    }
    .pill { transition: transform .15s ease, box-shadow .15s ease; }
    .pill:hover { transform: scale(1.05) translateY(-1px); box-shadow: 0 4px 14px rgba(0,0,0,.08); }
    /* Toast */
    #toast-wrap { position: fixed; right: 16px; bottom: 16px; z-index: 9999; display: grid; gap: 8px; }
    .toast { background: rgba(15,23,42,.95); color: #fff; padding: 10px 14px; border-radius: 10px; font-size: 12px; box-shadow: 0 6px 20px rgba(0,0,0,.2); opacity: 0; transform: translateY(10px); transition: opacity .2s ease, transform .2s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    /* Accordion */
    .acc-title { cursor: pointer; user-select: none; display:flex; align-items:center; justify-content:space-between; }
    .acc-title .chev { 
      transition: transform .2s ease; 
      width: 20px; 
      height: 20px; 
      background: #3b82f6; 
      border-radius: 4px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      position: relative;
    }
    .acc-title .chev::before {
      content: '';
      width: 0;
      height: 0;
      border-left: 6px solid white;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      margin-left: 2px;
    }
    .acc-title[aria-expanded="true"] .chev { transform: rotate(90deg); }
    /* ç´”æ–‡å­—é¢¨æ ¼çš„æ¨™é¡Œï¼ˆä¿ç•™å¯é»ï¼‰ */
    .acc-title { padding: 2px 0; }
  </style>
</head>
<body class="bg-slate-50">
  <div class="min-h-screen flex flex-col gap-4 p-4 max-w-4xl mx-auto">
    <!-- å·¦ï¼šå•†å“åº« / åŒ¯å…¥ / æ¨¡æ¿é¸æ“‡ -->
    <aside class="space-y-4">
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-lg font-bold mb-3">ç™»å…¥ï¼ˆç¤ºæ„ï¼Œä¸€éµç™»å…¥ï¼‰</h2>
        <div class="flex flex-wrap items-center gap-2">
          <button id="login-google" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Google</button>
          <button id="login-facebook" class="px-3 py-2 rounded-xl bg-sky-600 text-white">Facebook</button>
          <button id="login-line" class="px-3 py-2 rounded-xl bg-green-600 text-white">LINE</button>
          <div class="grow"></div>
          <span id="usage-display" class="text-sm font-medium"></span>
          <span id="login-state" class="text-xs text-slate-500">æœªç™»å…¥ï¼ˆéœ€ç™»å…¥æ‰èƒ½æ–°å¢æ¨£å¼/é‡˜é¸/åˆªé™¤ï¼‰</span>
          <button id="reset-data" class="ml-2 px-2 py-1 rounded-lg border text-xs">é‡ç½®æœ¬æ©Ÿè³‡æ–™</button>
          <button id="reset-user" class="ml-1 px-2 py-1 rounded-lg border text-xs bg-yellow-100">é‡ç½®ç”¨æˆ¶</button>
        </div>
      </div>

      <!-- æ–°å¢ï¼šåº—å®¶èˆ‡ DM å¡ç‰‡ -->
      <div class="bg-white rounded-2xl shadow p-4 acc" id="shop-camp-card" data-acc-key="shop-camp">
        <h2 class="text-lg font-bold mb-3 acc-title" aria-expanded="true">åº—å®¶èˆ‡ DM <span class="chev"></span></h2>
        <div class="space-y-3">
          <!-- åº—å®¶é¸æ“‡ -->
          <div>
            <div class="flex items-center justify-between mb-1">
              <label class="text-sm text-slate-600">åº—å®¶é¸æ“‡ï¼ˆå¿…é¸ï¼‰</label>
              <div class="flex items-center gap-2">
                <button id="btn-edit-shop-toggle" class="px-2 py-1 rounded-lg border text-xs hidden">ç·¨è¼¯åº—å®¶è³‡æ–™</button>
                <button id="btn-del-shop" class="px-2 py-1 rounded-lg border text-xs hidden text-rose-600">åˆªé™¤åº—å®¶</button>
                <button id="btn-add-shop-toggle" class="px-2 py-1 rounded-lg border text-xs">ï¼‹æ–°å¢åº—å®¶</button>
              </div>
            </div>
            <div id="shop-pill-list" class="flex flex-wrap gap-2"></div>
            <form id="form-add-shop" class="mt-2 hidden space-y-2 border rounded-xl p-2 bg-slate-50">
              <input class="w-full rounded-lg border p-2" name="shopName" placeholder="åº—åï¼ˆå¿…å¡«ï¼‰" required />
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs text-slate-500 mb-1">Logoï¼ˆé¸å¡«ï¼‰</label>
                  <input type="file" accept="image/*" name="shopLogo" class="w-full" />
                </div>
                <div>
                  <label class="block text-xs text-slate-500 mb-1">å“ç‰Œè‰²ï¼ˆé¸å¡«ï¼‰</label>
                  <input type="color" name="brandColor" class="w-full h-9 rounded-lg border" value="#0ea5e9" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <input class="rounded-lg border p-2" name="contactPerson" placeholder="è¯çµ¡äººï¼ˆé¸å¡«ï¼‰" />
                <input class="rounded-lg border p-2" name="contactPhone" placeholder="é›»è©±ï¼ˆé¸å¡«ï¼‰" />
                <input class="rounded-lg border p-2" name="contactLine" placeholder="LINE æˆ– @IDï¼ˆé¸å¡«ï¼‰" />
                <input class="rounded-lg border p-2" name="contactFacebook" placeholder="Facebookï¼ˆé¸å¡«ï¼‰" />
                <input class="rounded-lg border p-2" name="contactInstagram" placeholder="Instagramï¼ˆé¸å¡«ï¼‰" />
                <input class="rounded-lg border p-2" name="contactAddress" placeholder="åœ°å€ / å–è²¨åœ°ï¼ˆé¸å¡«ï¼‰" />
                <input class="rounded-lg border p-2 col-span-2" name="contactWebsite" placeholder="å®˜ç¶²/è¡¨å–®ï¼ˆå¯è²¼ç¶²å€ï¼Œé¸å¡«ï¼‰" />
              </div>
              <div class="flex items-center gap-2">
                <button type="submit" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm">å„²å­˜åº—å®¶</button>
                <button type="button" id="btn-cancel-add-shop" class="px-3 py-2 rounded-xl border text-sm">å–æ¶ˆ</button>
              </div>
            </form>

            <!-- ç·¨è¼¯åº—å®¶è³‡æ–™ï¼ˆé¡¯ç¤ºç›®å‰é¸å®šåº—å®¶è³‡è¨Šï¼‰ -->
            <form id="form-edit-shop" class="mt-2 hidden space-y-2 border rounded-xl p-2 bg-slate-50">
              <div class="text-xs text-slate-500">ç·¨è¼¯ç›®å‰é¸å®šçš„åº—å®¶è³‡æ–™</div>
              <input class="w-full rounded-lg border p-2" name="shopName" placeholder="åº—åï¼ˆå¿…å¡«ï¼‰" required />
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs text-slate-500 mb-1">Logoï¼ˆé‡æ–°ä¸Šå‚³å¯è¦†è“‹ï¼‰</label>
                  <input type="file" accept="image/*" name="shopLogo" class="w-full" />
                </div>
                <div>
                  <label class="block text-xs text-slate-500 mb-1">å“ç‰Œè‰²</label>
                  <input type="color" name="brandColor" class="w-full h-9 rounded-lg border" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <input class="rounded-lg border p-2" name="contactPerson" placeholder="è¯çµ¡äºº" />
                <input class="rounded-lg border p-2" name="contactPhone" placeholder="é›»è©±" />
                <input class="rounded-lg border p-2" name="contactLine" placeholder="LINE æˆ– @ID" />
                <input class="rounded-lg border p-2" name="contactFacebook" placeholder="Facebook" />
                <input class="rounded-lg border p-2" name="contactInstagram" placeholder="Instagram" />
                <input class="rounded-lg border p-2" name="contactAddress" placeholder="åœ°å€ / å–è²¨åœ°" />
                <input class="rounded-lg border p-2 col-span-2" name="contactWebsite" placeholder="å®˜ç¶²/è¡¨å–®ï¼ˆå¯è²¼ç¶²å€ï¼‰" />
              </div>
              <div class="flex items-center gap-2">
                <button type="submit" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">æ›´æ–°åº—å®¶</button>
                <button type="button" id="btn-cancel-edit-shop" class="px-3 py-2 rounded-xl border text-sm">å–æ¶ˆ</button>
              </div>
            </form>
          </div>

          <!-- DM æ–¹æ¡ˆï¼ˆé¸åˆ°åº—å®¶å¾Œæ‰é¡¯ç¤ºï¼‰ -->
          <div id="campaign-section" class="hidden">
            <div class="flex items-center justify-between mb-1">
              <label class="text-sm text-slate-600">DM æ–¹æ¡ˆé¸æ“‡ï¼ˆå¿…é¸ï¼‰</label>
              <button id="btn-add-campaign-toggle" class="px-2 py-1 rounded-lg border text-xs">ï¼‹æ–°å¢ DM æ–¹æ¡ˆ</button>
            </div>
            <div id="campaign-pill-list" class="flex flex-wrap gap-2"></div>
            <form id="form-add-campaign" class="mt-2 hidden space-y-2 border rounded-xl p-2 bg-slate-50">
              <input class="w-full rounded-lg border p-2" name="campaignName" placeholder="æ–¹æ¡ˆåç¨±ï¼ˆå¿…å¡«ï¼‰" required />
              <div class="text-xs text-slate-500">å°‡ä»¥ç›®å‰ç•«é¢æ¨£å¼è¨­å®šå»ºç«‹æ–¹æ¡ˆï¼ˆæˆ–å¯ä¹‹å¾Œå†èª¿æ•´ï¼‰ã€‚</div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block text-xs text-slate-500 mb-1">ä¸Šå‚³ QR åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰</label>
                <input type="file" accept="image/*" name="qrImage" class="w-full" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">æˆ–ç”¢ç”Ÿ QRï¼ˆè²¼ç¶²å€ï¼‰</label>
                <input type="url" name="qrUrl" class="w-full rounded-lg border p-2" placeholder="https://..." />
              </div>
            </div>
              <div class="flex items-center gap-2">
                <button type="submit" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm">å»ºç«‹æ–¹æ¡ˆ</button>
                <button type="button" id="btn-cancel-add-campaign" class="px-3 py-2 rounded-xl border text-sm">å–æ¶ˆ</button>
              </div>
            </form>

            <!-- ç·¨è¼¯ç¾æœ‰æ–¹æ¡ˆï¼ˆé‡å°é¸ä¸­çš„æ–¹æ¡ˆï¼‰ -->
            <form id="form-edit-campaign" class="mt-2 hidden space-y-2 border rounded-xl p-2 bg-slate-50">
              <div class="text-xs text-slate-500">ç·¨è¼¯ç›®å‰é¸å®šçš„ DM æ–¹æ¡ˆ</div>
              <input class="w-full rounded-lg border p-2" name="campaignName" placeholder="æ–¹æ¡ˆåç¨±ï¼ˆå¿…å¡«ï¼‰" required />
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs text-slate-500 mb-1">ä¸Šå‚³ QR åœ–ç‰‡ï¼ˆè¦†è“‹ï¼‰</label>
                  <input type="file" accept="image/*" name="qrImage" class="w-full" />
                </div>
                <div>
                  <label class="block text-xs text-slate-500 mb-1">æˆ–æ›´æ–° QRï¼ˆè²¼ç¶²å€ï¼‰</label>
                  <input type="url" name="qrUrl" class="w-full rounded-lg border p-2" placeholder="https://..." />
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button type="submit" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">æ›´æ–°æ–¹æ¡ˆ</button>
                <button type="button" id="btn-del-campaign" class="px-3 py-2 rounded-xl border text-sm text-rose-600">åˆªé™¤æ–¹æ¡ˆ</button>
                <button type="button" id="btn-cancel-edit-campaign" class="px-3 py-2 rounded-xl border text-sm">å–æ¶ˆ</button>
              </div>
            </form>
          </div>

          <div id="chosen-summary" class="text-xs text-slate-600"></div>
        </div>
      </div>

      <!-- 1) æ–°å¢å•†å“ -->
      <div class="bg-white rounded-2xl shadow p-4 acc" data-acc-key="add-product">
        <h2 class="text-lg font-bold mb-3 acc-title" aria-expanded="false">æ–°å¢å•†å“ <span class="chev"></span></h2>
        <form id="product-form" class="space-y-3">
          <input class="w-full rounded-xl border p-2" name="name" placeholder="å•†å“åç¨±" required />
          <div class="grid grid-cols-2 gap-2">
            <input class="rounded-xl border p-2" name="price" placeholder="å”®åƒ¹ (å¿…å¡«)" type="number" step="1" required />
            <input class="rounded-xl border p-2" name="originalPrice" placeholder="åŸåƒ¹ (é¸å¡«)" type="number" step="1" />
          </div>
          <div class="relative">
            <textarea class="w-full rounded-xl border p-2 pr-20" name="desc" rows="2" placeholder="å•†å“æè¿°ï¼ˆé¸å¡«ï¼‰"></textarea>
            <button type="button" id="ai-desc-btn" class="absolute right-2 top-2 px-3 py-1 text-xs rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors" title="AIç”Ÿæˆæè¿°">AI</button>
          </div>
          <div class="flex items-center gap-2">
            <input type="file" accept="image/*" id="img-input" class="hidden" />
            <button type="button" id="pick-img" class="px-3 py-2 rounded-xl bg-slate-800 text-white">ä¸Šå‚³ä¸»åœ–</button>
            <span id="img-name" class="text-sm text-slate-500">å°šæœªé¸æ“‡</span>
          </div>
          <button type="submit" class="w-full py-2 rounded-xl bg-indigo-600 text-white font-semibold">åŠ å…¥å•†å“åº«</button>
        </form>
        
      </div>

      <!-- DM è£½ä½œè¨­å®šï¼ˆå¤§é …ï¼‰ -->
      <div class="bg-white rounded-2xl shadow p-4 acc" data-acc-key="dm-settings">
        <h2 class="text-lg font-bold mb-3 acc-title" aria-expanded="false">DM è£½ä½œè¨­å®š <span class="chev"></span></h2>

        <!-- 2) é è¨­æ¨£å¼ï¼ˆç§»åˆ°æ–°å¢å•†å“ä¸‹æ–¹ï¼‰ -->
        <div class="acc" data-acc-key="presets">
          <h3 class="text-base font-semibold mb-2 acc-title" aria-expanded="false">é è¨­æ¨£å¼ <span class="chev"></span></h3>
          <div>
        <div class="flex gap-2 mb-2">
          <input id="preset-add-name" class="flex-1 rounded-xl border p-2" placeholder="æ–°å¢æ¨£å¼åç¨±ï¼ˆä½¿ç”¨ç›®å‰è¨­å®šï¼‰" />
          <button id="preset-add-btn" class="px-3 py-2 rounded-xl bg-indigo-600 text-white">æ–°å¢</button>
        </div>
        <div id="preset-list" class="flex flex-wrap gap-2"></div>
        <p class="text-xs text-slate-500 mt-2">å››é¡†åˆ¶å¼é è¨­æœƒå…ˆé¡¯ç¤ºã€‚ç™»å…¥å¾Œå¯æ–°å¢/åˆªé™¤/é‡˜é¸ï¼ˆæœƒå„²å­˜åˆ°å¸³è™Ÿï¼‰ã€‚</p>
          </div>
      </div>

        <!-- 3) DM é¡¯ç¤ºé …ç›®ï¼ˆç§»åˆ°é è¨­æ¨£å¼ä¸‹æ–¹ï¼‰ -->
        <div class="acc" data-acc-key="dm-display">
          <h3 class="text-base font-semibold mb-2 acc-title" aria-expanded="false">DM é¡¯ç¤ºé …ç›® <span class="chev"></span></h3>
          <div class="space-y-2" id="dm-display-box">
          <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="opt-show-shop" class="rounded" /> é¡¯ç¤ºåº—å®¶åç¨±</label>
          <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="opt-show-camp" class="rounded" /> é¡¯ç¤º DM åç¨±</label>
          <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="opt-show-logo" class="rounded" /> é¡¯ç¤ºåº—å®¶ Logoï¼ˆå³ä¸Šè§’ï¼‰</label>
          <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="opt-show-contact" class="rounded" /> é¡¯ç¤ºè¯çµ¡æ–¹å¼ï¼ˆæ’æˆæ®µè½ï¼‰</label>
          <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="opt-show-notes" class="rounded" /> é¡¯ç¤º DM èªªæ˜</label>
            <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="opt-show-qr" class="rounded" /> é¡¯ç¤º QRï¼ˆè‹¥æ–¹æ¡ˆä¸­æœ‰ QRï¼‰</label>
          <div class="grid grid-cols-2 gap-2 items-center">
            <label class="inline-flex items-center gap-2 text-sm col-span-1"><input type="checkbox" id="opt-show-badge" class="rounded" /> é¡¯ç¤ºä¿ƒéŠ·å¾½ç« </label>
            <input id="opt-badge-text" class="col-span-1 rounded-xl border p-2 text-sm" placeholder="å¾½ç« æ–‡å­—ï¼ˆå¦‚ï¼šé™æ™‚ç‰¹åƒ¹ï¼‰" />
          </div>
          <div class="grid grid-cols-2 gap-2 items-center">
            <label class="text-sm">é‚Šæ¡†æ¨£å¼ï¼š</label>
            <select id="opt-border-style" class="rounded-xl border p-2 text-sm">
              <option value="none">ç„¡é‚Šæ¡†</option>
              <option value="solid">å¯¦ç·š</option>
              <option value="dashed">è™›ç·š</option>
              <option value="dotted">é»ç·š</option>
              <option value="double">é›™ç·š</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-2 items-center">
            <label class="text-sm">é‚Šæ¡†é¡è‰²ï¼š</label>
            <input type="color" id="opt-border-color" class="rounded-xl border p-1 h-10" value="#e2e8f0" />
          </div>
          <div class="grid grid-cols-2 gap-2 items-center">
            <label class="text-sm">èƒŒæ™¯é¡è‰²ï¼š</label>
            <input type="color" id="opt-background-color" class="rounded-xl border p-1 h-10" value="#ffffff" />
          </div>
          <textarea id="opt-notes" rows="3" class="w-full rounded-xl border p-2 hidden" placeholder="é‹è²»ã€å¯„ä»¶æ–¹å¼ã€æª”æœŸæ™‚é–“ã€æ³¨æ„äº‹é …â€¦"></textarea>
          <p class="text-xs text-slate-500">è®Šæ›´æœƒç«‹å³å¥—ç”¨åˆ°é è¦½èˆ‡è¼¸å‡ºï¼ˆé ˆå…ˆé¸åº—å®¶èˆ‡æ–¹æ¡ˆï¼‰ã€‚</p>
          </div>
        </div>

        <!-- 4) æ¨¡æ¿èˆ‡åœ–ç‰‡æ¨£å¼ -->
        <div class="acc" data-acc-key="styles">
          <h3 class="text-base font-semibold mb-2 acc-title" aria-expanded="false">æ¨¡æ¿èˆ‡åœ–ç‰‡æ¨£å¼ <span class="chev"></span></h3>
          <div>
        <div class="space-y-2">
          <label class="block text-sm text-slate-600">æ¨¡æ¿</label>
          <select id="template-select" class="w-full rounded-xl border p-2">
            <option value="single">å–®å“ï¼ˆå·¦å³ç‰ˆï¼‰</option>
            <option value="singleFull">å–®å“ï¼ˆæ»¿ç‰ˆèƒŒæ™¯ï¼‰</option>
            <option value="grid9">ä¹å®®æ ¼ï¼ˆæœ€å¤š 9 ä»¶ï¼‰</option>
            <option value="list">æ¸…å–®å¼ï¼ˆæ¨™é¡Œï¼‹åƒ¹éŒ¢ï¼‰</option>
          </select>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm text-slate-600">åœ–ç‰‡å¡«å……</label>
            <select id="fit-select" class="w-full rounded-xl border p-2">
              <option value="cover">è£åˆ‡å¡«æ»¿ï¼ˆéŠ³åˆ©ï¼‰</option>
              <option value="contain">å®Œæ•´ç½®å…¥ï¼ˆä¸è£åˆ‡ï¼‰</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-600">åœ–ç‰‡å°é½Š</label>
            <select id="pos-select" class="w-full rounded-xl border p-2">
              <option value="center">ç½®ä¸­</option>
              <option value="top">é ä¸Š</option>
              <option value="bottom">é ä¸‹</option>
              <option value="left">é å·¦</option>
              <option value="right">é å³</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-600">åœ–ç‰‡æ¡†æ¯”ä¾‹ï¼ˆå–®å“/æ¸…å–®ï¼‰</label>
            <select id="ratio-select" class="w-full rounded-xl border p-2">
              <option value="1/1">1:1ï¼ˆæ­£æ–¹ï¼‰</option>
              <option value="4/5" selected>4:5ï¼ˆIG æ¨è–¦ï¼‰</option>
              <option value="3/4">3:4</option>
              <option value="16/9">16:9ï¼ˆæ©«å¼ï¼‰</option>
            </select>
          </div>
        </div>
        <div class="mt-4 space-y-2">
          <label class="block text-sm text-slate-600">ï¼ˆä¹å®®æ ¼ï¼‰å¡ç‰‡é«˜åº¦</label>
          <select id="grid-card-h" class="w-full rounded-xl border p-2">
            <option value="320">å°ï¼ˆ320pxï¼‰</option>
            <option value="360" selected>ä¸­ï¼ˆ360pxï¼‰</option>
            <option value="420">å¤§ï¼ˆ420pxï¼‰</option>
          </select>
          <label class="block text-sm text-slate-600 mt-2">ï¼ˆä¹å®®æ ¼ï¼‰åœ–ç‰‡å å¡ç‰‡æ¯”ä¾‹</label>
          <select id="grid-img-frac" class="w-full rounded-xl border p-2">
            <option value="0.4">40%</option>
            <option value="0.5">50%</option>
            <option value="0.6" selected>60%</option>
            <option value="0.7">70%</option>
          </select>
          <label class="inline-flex items-center gap-2 text-sm"><input id="grid-fill" type="checkbox" class="rounded" checked> ä¸è¶³ 9 ä»¶ä»¥ç©ºç™½å¡è£œé½Šï¼ˆå›ºå®š 3Ã—3ï¼‰</label>
        </div>
        </div>
      </div>

        <!-- 5) æ‰¹é‡åŒ¯å…¥ï¼ˆç§»åˆ°æ¨¡æ¿æ¨£å¼ä¸‹æ–¹ï¼Œä¸¦æ–°å¢ã€Œä¸‹è¼‰ç¯„æœ¬ã€ï¼‰ -->
        <div class="acc" data-acc-key="csv-import">
          <h3 class="text-base font-semibold mb-2 acc-title" aria-expanded="false">æ‰¹é‡åŒ¯å…¥ï¼ˆCSV/Excelï¼‰<span class="chev"></span></h3>
          <div>
        <p class="text-sm text-slate-600 mb-2">æ¬„ä½ï¼šname, price, originalPrice, desc, imageUrl</p>
        <input type="file" id="csv-input" accept=".csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
        <div class="mt-2">
          <button id="btn-download-template" class="px-3 py-2 rounded-xl border text-sm">ä¸‹è¼‰ç©ºç™½ç¯„æœ¬</button>
        </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- ä¸­ï¼šå•†å“åˆ—è¡¨ï¼ˆå¯å‹¾é¸é€² DMï¼‰ -->
    <section class="bg-white rounded-2xl shadow overflow-hidden acc">
      <div class="acc-title cursor-pointer p-4 flex items-center justify-between">
        <h2 class="text-lg font-bold">å•†å“åº«ï¼ˆå‹¾é¸è¦æ”¾é€² DM çš„å•†å“ï¼‰</h2>
        <span class="chev"></span>
      </div>
      <div class="acc-content p-4 pt-0">
        <!-- AIæè¿°ç”Ÿæˆå·¥å…· -->
        <div class="mb-4 p-3 bg-blue-50 rounded-xl">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold text-blue-800">AIæè¿°ç”Ÿæˆå·¥å…·</h3>
            <span class="text-xs text-blue-600">æ™ºèƒ½ç”Ÿæˆå•†å“æè¿°</span>
          </div>
          <div class="flex gap-2">
            <button type="button" id="batch-ai-desc" class="flex-1 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition-colors">
              ç‚ºæ‰€æœ‰å•†å“ç”ŸæˆAIæè¿°
            </button>
            <button type="button" id="ai-desc-selected" class="px-4 py-2 rounded-lg bg-blue-500 text-white text-sm font-medium hover:bg-blue-600 transition-colors">
              ç‚ºé¸ä¸­å•†å“ç”Ÿæˆ
            </button>
          </div>
        </div>
        
        <div id="product-table" class="overflow-auto max-h-[50vh]">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-slate-100">
              <tr>
                <th class="p-2 text-left"><input type="checkbox" id="select-all"></th>
                <th class="p-2 text-left">åœ–ç‰‡</th>
                <th class="p-2 text-left">åç¨±</th>
                <th class="p-2 text-left">å”®åƒ¹</th>
                <th class="p-2 text-left">åŸåƒ¹</th>
                <th class="p-2 text-left">æè¿°</th>
              </tr>
            </thead>
            <tbody id="product-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- å³ï¼šDM ç•«å¸ƒé è¦½å€ -->
    <section class="bg-white rounded-2xl shadow p-4">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 gap-2">
        <h2 class="text-lg font-bold">DM é è¦½ï¼ˆ1080 Ã— 1350ï¼‰</h2>
        <div class="flex items-center gap-2 text-sm flex-wrap">
          <button id="zoom-fit" class="px-2 py-1 rounded-lg border">é©æ‡‰</button>
          <button class="px-2 py-1 rounded-lg border zoom-btn" data-z="1">100%</button>
          <button class="px-2 py-1 rounded-lg border zoom-btn" data-z="0.75">75%</button>
          <button class="px-2 py-1 rounded-lg border zoom-btn" data-z="0.5">50%</button>
          <div class="flex items-center gap-1">
            <input type="range" id="zoom-range" min="0.25" max="1" step="0.05" value="0.6" />
            <span id="zoom-val" class="w-12 text-right">60%</span>
          </div>
        </div>
      </div>
      <div id="preview-wrap" class="overflow-auto max-h-[60vh] bg-slate-100 rounded-xl p-3">
        <div id="scale-wrap">
          <div id="dm-canvas" class="relative bg-gradient-to-br from-white via-slate-50 to-slate-100 rounded-2xl shadow-inner border overflow-visible block">
            <!-- å‹•æ…‹æ³¨å…¥æ¨¡æ¿å…§å®¹ -->
          </div>
        </div>
      </div>
      <div class="mt-3 space-y-3">
        <div class="flex items-center gap-2 text-sm">
          <label class="text-slate-600">ä¸‹è¼‰ç¯„åœï¼š</label>
          <select id="download-range" class="px-2 py-1 border rounded text-sm">
            <option value="all">å…¨éƒ¨é é¢</option>
            <option value="current">ç•¶å‰é é¢</option>
            <option value="custom">è‡ªè¨‚ç¯„åœ</option>
          </select>
          <div id="custom-range" class="hidden flex items-center gap-1">
            <input type="number" id="start-page" placeholder="èµ·å§‹" min="1" class="w-16 px-1 py-1 border rounded text-sm">
            <span class="text-slate-500">-</span>
            <input type="number" id="end-page" placeholder="çµæŸ" min="1" class="w-16 px-1 py-1 border rounded text-sm">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <button id="download-png" class="px-3 py-2 rounded-xl bg-rose-600 text-white">ä¸‹è¼‰ PNG</button>
          <button id="download-pdf" class="px-3 py-2 rounded-xl bg-amber-600 text-white">ä¸‹è¼‰ PDF</button>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-2">æç¤ºï¼šç¸®æ”¾åªå½±éŸ¿é è¦½ï¼Œä¸å½±éŸ¿è¼¸å‡ºå°ºå¯¸èˆ‡æ¸…æ™°åº¦ã€‚</p>
    </section>
  </div>

  <script>
  (function(){
    'use strict';

    // ===== ç‹€æ…‹ =====
    const state = {
      user: null, // { id, name, email, isPremium, usageCount, maxUsage }
      products: [],
      selection: new Set(),
      template: 'grid9',
      preview: { scale: 0.6, fit: false },
      imgFit: 'cover',
      imgPos: 'center',
      imgRatio: '4/5',
      gridCardH: 360,
      gridFill: true,
      gridImgFrac: 0.6,
      selectedShopId: null,
      selectedCampaignId: null,
      // è—æ˜Ÿæ”¯ä»˜è¨­å®š
      bluePayConfig: {
        hashKey: 'aOJQQQboFFK4VcyHmpZR20BGvn6Nod6p',
        hashIV: 'Pq0fAp1cEnSQhTlC',
        merchantId: 'your_merchant_id', // éœ€è¦å¾è—æ˜Ÿå¾Œå°ç²å–
        notifyUrl: 'https://ww3e23.github.io/DM-/payment-notify.html',
        returnUrl: 'https://ww3e23.github.io/DM-/payment-success.html'
      },
      // ä½¿ç”¨é™åˆ¶è¨­å®š
      usageLimits: {
        freeTrial: 3, // å…è²»è©¦ç”¨æ¬¡æ•¸
        premiumPrice: 299, // ä»˜è²»åƒ¹æ ¼ (å°å¹£)
        premiumFeatures: ['unlimited_usage', 'all_templates', 'high_res_export']
      }
    };

    // ===== DOM å¿«å– =====
    const els = {
      loginGoogle: document.getElementById('login-google'),
      loginFacebook: document.getElementById('login-facebook'),
      loginLINE: document.getElementById('login-line'),
      loginState: document.getElementById('login-state'),
      resetData: document.getElementById('reset-data'),
      resetUser: document.getElementById('reset-user'),
      // Shops & Campaigns
      shopCard: document.getElementById('shop-camp-card'),
      shopPills: document.getElementById('shop-pill-list'),
      btnAddShopToggle: document.getElementById('btn-add-shop-toggle'),
      btnEditShopToggle: document.getElementById('btn-edit-shop-toggle'),
      btnDelShop: document.getElementById('btn-del-shop'),
      formAddShop: document.getElementById('form-add-shop'),
      btnCancelAddShop: document.getElementById('btn-cancel-add-shop'),
      formEditShop: document.getElementById('form-edit-shop'),
      btnCancelEditShop: document.getElementById('btn-cancel-edit-shop'),
      campaignSection: document.getElementById('campaign-section'),
      campaignPills: document.getElementById('campaign-pill-list'),
      btnAddCampaignToggle: document.getElementById('btn-add-campaign-toggle'),
      formAddCampaign: document.getElementById('form-add-campaign'),
      btnCancelAddCampaign: document.getElementById('btn-cancel-add-campaign'),
      formEditCampaign: document.getElementById('form-edit-campaign'),
      btnCancelEditCampaign: document.getElementById('btn-cancel-edit-campaign'),
      btnDelCampaign: document.getElementById('btn-del-campaign'),
      chosenSummary: document.getElementById('chosen-summary'),

      imgInput: document.getElementById('img-input'),
      pickImg: document.getElementById('pick-img'),
      imgName: document.getElementById('img-name'),
      form: document.getElementById('product-form'),
      csvInput: document.getElementById('csv-input'),
      tbody: document.getElementById('product-tbody'),
      templateSelect: document.getElementById('template-select'),
      previewWrap: document.getElementById('preview-wrap'),
      scaleWrap: document.getElementById('scale-wrap'),
      dmCanvas: document.getElementById('dm-canvas'),
      downloadPng: document.getElementById('download-png'),
      downloadPdf: document.getElementById('download-pdf'),
      downloadRange: document.getElementById('download-range'),
      customRange: document.getElementById('custom-range'),
      startPage: document.getElementById('start-page'),
      endPage: document.getElementById('end-page'),
      zoomFit: document.getElementById('zoom-fit'),
      zoomBtns: document.querySelectorAll('.zoom-btn'),
      zoomRange: document.getElementById('zoom-range'),
      zoomVal: document.getElementById('zoom-val'),
      fitSelect: document.getElementById('fit-select'),
      posSelect: document.getElementById('pos-select'),
      ratioSelect: document.getElementById('ratio-select'),
      gridCardH: document.getElementById('grid-card-h'),
      gridFill: document.getElementById('grid-fill'),
      gridImgFrac: document.getElementById('grid-img-frac'),
      presetList: document.getElementById('preset-list'),
      presetAddName: document.getElementById('preset-add-name'),
      presetAddBtn: document.getElementById('preset-add-btn'),
      // Display options
      optShowShop: document.getElementById('opt-show-shop'),
      optShowCamp: document.getElementById('opt-show-camp'),
      optShowContact: document.getElementById('opt-show-contact'),
      optShowNotes: document.getElementById('opt-show-notes'),
      optNotes: document.getElementById('opt-notes'),
      optShowBadge: document.getElementById('opt-show-badge'),
      optBadgeText: document.getElementById('opt-badge-text'),
      optShowLogo: document.getElementById('opt-show-logo'),
      optShowQR: document.getElementById('opt-show-qr'),
      optBorderStyle: document.getElementById('opt-border-style'),
      optBorderColor: document.getElementById('opt-border-color'),
      optBackgroundColor: document.getElementById('opt-background-color'),
    };

    // ===== å·¥å…· =====
    const uid = () => Math.random().toString(36).slice(2,10);

    function priceTag(price){
      return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(Number(price||0));
    }

    function escapeHtml(str){
      return (str||'').toString().replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
    }

    // Toast ç°¡æ˜“æç¤º
    function ensureToastHost(){ let host = document.getElementById('toast-wrap'); if (!host){ host = document.createElement('div'); host.id='toast-wrap'; document.body.appendChild(host); } return host; }
    function toast(message, ms=1800){ const host=ensureToastHost(); const t=document.createElement('div'); t.className='toast'; t.textContent=message; host.appendChild(t); requestAnimationFrame(()=> t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(), 250); }, ms); }

    // ===== ç”¨æˆ¶ç®¡ç†ç³»çµ± =====
    function initUser() {
      const savedUser = localStorage.getItem('dm_user');
      if (savedUser) {
        try {
          state.user = JSON.parse(savedUser);
          // ç¢ºä¿ç”¨æˆ¶å°è±¡æœ‰å¿…è¦çš„å±¬æ€§
          if (typeof state.user.isPremium === 'undefined') {
            state.user.isPremium = false;
          }
          if (typeof state.user.usageCount === 'undefined') {
            state.user.usageCount = 0;
          }
          if (typeof state.user.maxUsage === 'undefined') {
            state.user.maxUsage = state.usageLimits.freeTrial;
          }
          console.log('è¼‰å…¥ç¾æœ‰ç”¨æˆ¶:', state.user);
        } catch (e) {
          console.error('è§£æç”¨æˆ¶æ•¸æ“šå¤±æ•—:', e);
          createNewUser();
        }
      } else {
        createNewUser();
      }
      updateUsageDisplay();
    }
    
    function createNewUser() {
      // å‰µå»ºåŒ¿åç”¨æˆ¶
      state.user = {
        id: 'anonymous_' + Date.now(),
        name: 'è¨ªå®¢',
        email: null,
        isPremium: false,
        usageCount: 0,
        maxUsage: state.usageLimits.freeTrial,
        createdAt: new Date().toISOString()
      };
      saveUser();
      console.log('å‰µå»ºæ–°ç”¨æˆ¶:', state.user);
    }

    function saveUser() {
      localStorage.setItem('dm_user', JSON.stringify(state.user));
    }

    function updateUsageDisplay() {
      const usageEl = document.getElementById('usage-display');
      if (usageEl) {
        const remaining = state.user.maxUsage - state.user.usageCount;
        if (state.user.isPremium) {
          usageEl.innerHTML = '<span class="text-green-600 font-semibold">âˆ ç„¡é™ä½¿ç”¨</span>';
        } else {
          usageEl.innerHTML = `<span class="text-orange-600">å‰©é¤˜ ${remaining} æ¬¡</span>`;
        }
      }
    }

    function checkUsageLimit() {
      console.log('æª¢æŸ¥ä½¿ç”¨é™åˆ¶:', {
        user: state.user,
        isPremium: state.user?.isPremium,
        usageCount: state.user?.usageCount,
        maxUsage: state.user?.maxUsage
      });
      
      if (!state.user) {
        console.log('ç”¨æˆ¶æœªåˆå§‹åŒ–ï¼Œé¡¯ç¤ºä»˜è²»è¦–çª—');
        return false;
      }
      
      if (state.user.isPremium) return true;
      return state.user.usageCount < state.user.maxUsage;
    }

    function incrementUsage() {
      if (!state.user.isPremium) {
        state.user.usageCount++;
        saveUser();
        updateUsageDisplay();
      }
    }

    function unlockPremium() {
      state.user.isPremium = true;
      state.user.maxUsage = Infinity;
      saveUser();
      updateUsageDisplay();
      toast('ğŸ‰ æ­å–œï¼å·²è§£é–é«˜ç´šåŠŸèƒ½ï¼');
    }

    // ===== è—æ˜Ÿæ”¯ä»˜ç³»çµ± =====
    function generateBluePayForm(amount, orderId) {
      const config = state.bluePayConfig;
      const data = {
        MerchantID: config.merchantId,
        MerchantTradeNo: orderId,
        MerchantTradeDate: new Date().toISOString().replace(/[-:]/g, '').replace(/\..+/, ''),
        PaymentType: 'aio',
        TotalAmount: amount,
        TradeDesc: 'DMç”Ÿç”¢å™¨é«˜ç´šç‰ˆ',
        ItemName: 'DMç”Ÿç”¢å™¨é«˜ç´šç‰ˆ',
        ReturnURL: config.returnUrl,
        NotifyURL: config.notifyUrl,
        ClientBackURL: window.location.href,
        ChoosePayment: 'ALL',
        EncryptType: 1
      };

      // ç”Ÿæˆæª¢æŸ¥ç¢¼ (ç°¡åŒ–ç‰ˆï¼Œå¯¦éš›éœ€è¦æŒ‰ç…§è—æ˜ŸAPIæ–‡æª”)
      const checkValue = generateCheckValue(data, config.hashKey, config.hashIV);
      data.CheckMacValue = checkValue;

      return data;
    }

    function generateCheckValue(data, hashKey, hashIV) {
      // ç°¡åŒ–çš„æª¢æŸ¥ç¢¼ç”Ÿæˆï¼Œå¯¦éš›éœ€è¦æŒ‰ç…§è—æ˜ŸAPIè¦ç¯„
      const sortedKeys = Object.keys(data).sort();
      let queryString = '';
      sortedKeys.forEach(key => {
        if (data[key] !== '') {
          queryString += `${key}=${data[key]}&`;
        }
      });
      queryString = queryString.slice(0, -1);
      
      // å¯¦éš›æ‡‰è©²ä½¿ç”¨AESåŠ å¯†ï¼Œé€™è£¡ç°¡åŒ–è™•ç†
      return btoa(queryString + hashKey + hashIV).substring(0, 32);
    }

    function showPaymentModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
          <h3 class="text-xl font-bold mb-4">å‡ç´šåˆ°é«˜ç´šç‰ˆ</h3>
          <div class="mb-4">
            <p class="text-gray-600 mb-2">å…è²»è©¦ç”¨æ¬¡æ•¸å·²ç”¨å®Œ</p>
            <p class="text-sm text-gray-500">å‡ç´šå¾Œå¯äº«å—ï¼š</p>
            <ul class="text-sm text-gray-600 mt-2 space-y-1">
              <li>â€¢ ç„¡é™æ¬¡ä½¿ç”¨</li>
              <li>â€¢ æ‰€æœ‰æ¨¡æ¿</li>
              <li>â€¢ é«˜è§£æåº¦è¼¸å‡º</li>
            </ul>
          </div>
          <div class="flex gap-3">
            <button id="pay-now" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
              ç«‹å³ä»˜è²» NT$ ${state.usageLimits.premiumPrice}
            </button>
            <button id="close-modal" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              å–æ¶ˆ
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('pay-now').addEventListener('click', () => {
        processPayment();
        modal.remove();
      });
      
      document.getElementById('close-modal').addEventListener('click', () => {
        modal.remove();
      });
    }

    function processPayment() {
      const orderId = 'DM_' + Date.now();
      const paymentData = generateBluePayForm(state.usageLimits.premiumPrice, orderId);
      
      // å‰µå»ºè¡¨å–®ä¸¦æäº¤åˆ°è—æ˜Ÿæ”¯ä»˜
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'https://payment.ecpay.com.tw/Cashier/AioCheckOut/V5'; // è—æ˜Ÿæ”¯ä»˜ç¶²é—œ
      form.target = '_blank';
      
      Object.keys(paymentData).forEach(key => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = paymentData[key];
        form.appendChild(input);
      });
      
      document.body.appendChild(form);
      form.submit();
      document.body.removeChild(form);
      
      toast('æ­£åœ¨è·³è½‰åˆ°ä»˜æ¬¾é é¢...');
    }

    // åœ¨æŸäº›ç’°å¢ƒï¼ˆå…§åµŒå®¹å™¨/è¡Œå‹•ç€è¦½å™¨ï¼‰æœƒå°é– alert/confirm/promptã€‚
    // ä½¿ç”¨å®‰å…¨ç‰ˆ confirmï¼šè‹¥ä¸å¯ç”¨å‰‡é»˜èªé€šéï¼Œé¿å…æ“ä½œå¡ä½ã€‚
    function safeConfirm(msg){
      try {
        if (typeof window.confirm === 'function') return window.confirm(msg);
      } catch (e) {
        console.warn('window.confirm ä¸å¯ç”¨ï¼Œæ¡ç”¨ fallback', e);
      }
      // fallbackï¼šç›´æ¥è¦–ç‚ºç¢ºèª
      return true;
    }

    // ===== ç™»å…¥ï¼ˆç¤ºæ„ï¼‰ =====
    function setUser(u){
      state.user = u;
      els.loginState.textContent = u ? scopeString() : 'æœªç™»å…¥ï¼ˆéœ€ç™»å…¥æ‰èƒ½æ–°å¢æ¨£å¼/é‡˜é¸/åˆªé™¤ï¼‰';
      updatePresetControls();
      updateAccordionLock();
      // æ¸…ç†æ¸¬è©¦æ®˜ç•™è³‡æ–™ï¼ˆé¿å…é¡¯ç¤ºåº—T19ç­‰æ¸¬è©¦åº—å®¶ï¼‰
      try { cleanupTestArtifacts(); renderShopPills(); } catch(e) { console.warn('cleanupTestArtifacts error', e); }
    }
    // ===== Shops / Campaigns è³‡æ–™èˆ‡ UI =====
    const SHOPS_KEY_PREFIX = 'dm-shops-v1:';
    const CAMPS_KEY_PREFIX = 'dm-campaigns-v1:'; // {userId}:{shopId}
    const PRESET_V5_PREFIX = 'dm-presets-v5:'; // {userId}:{shopId}:{campaignId}

    function shopsKey(){ return state.user ? SHOPS_KEY_PREFIX + state.user.id : null; }
    function campsKey(shopId){ return state.user && shopId ? `${CAMPS_KEY_PREFIX}${state.user.id}:${shopId}` : null; }
    function presetsV5Key(shopId, campId){ return state.user && shopId && campId ? `${PRESET_V5_PREFIX}${state.user.id}:${shopId}:${campId}` : null; }

    function loadShops(){
      const k = shopsKey(); if (!k) return [];
      try { const raw = localStorage.getItem(k); const arr = JSON.parse(raw||'[]'); return Array.isArray(arr)?arr:[]; } catch{ return []; }
    }
    function saveShops(list){ const k=shopsKey(); if (!k){ alert('è«‹å…ˆç™»å…¥'); return false; } try{ localStorage.setItem(k, JSON.stringify(list)); return true; } catch(e){ alert('å„²å­˜åº—å®¶å¤±æ•—'); return false; } }
    function loadCamps(shopId){ const k=campsKey(shopId); if (!k) return []; try{ const raw=localStorage.getItem(k); const arr=JSON.parse(raw||'[]'); return Array.isArray(arr)?arr:[]; }catch{ return []; } }
    function saveCamps(shopId, list){ const k=campsKey(shopId); if (!k){ alert('è«‹å…ˆç™»å…¥'); return false; } try{ localStorage.setItem(k, JSON.stringify(list)); return true; } catch{ alert('å„²å­˜æ–¹æ¡ˆå¤±æ•—'); return false; } }

    function findShopById(id){ return loadShops().find(s=>s.id===id)||null; }
    function findCampById(shopId, id){ return loadCamps(shopId).find(c=>c.id===id)||null; }

    function scopeString(){
      const user = state.user? state.user.name : 'æœªç™»å…¥';
      const shop = state.selectedShopId? (findShopById(state.selectedShopId)?.name||'') : 'â€”';
      const camp = state.selectedCampaignId? (findCampById(state.selectedShopId, state.selectedCampaignId)?.name||'') : 'â€”';
      return state.user ? `å·²ç™»å…¥ï¼š${user} ï½œ åº—å®¶ï¼š${shop} ï½œ æ–¹æ¡ˆï¼š${camp}` : 'æœªç™»å…¥ï¼ˆéœ€ç™»å…¥æ‰èƒ½æ–°å¢æ¨£å¼/é‡˜é¸/åˆªé™¤ï¼‰';
    }

    function renderChosenSummary(){
      els.loginState.textContent = scopeString();
      if (state.selectedShopId && state.selectedCampaignId){
        const sn = findShopById(state.selectedShopId)?.name || '';
        const cn = findCampById(state.selectedShopId, state.selectedCampaignId)?.name || '';
        els.chosenSummary.textContent = `å·²é¸ï¼šåº—å®¶ã€Œ${sn}ã€ï¼DM æ–¹æ¡ˆã€Œ${cn}ã€`;
      } else {
        els.chosenSummary.textContent = '';
      }
    }

    function renderShopPills(){
      const shops = loadShops();
      els.shopPills.innerHTML = '';
      for (const s of shops){
        const btn = document.createElement('button');
        btn.type='button';
        btn.className = 'pill px-3 py-1 rounded-full border bg-white text-sm';
        btn.textContent = s.name;
        if (s.id===state.selectedShopId) btn.classList.add('bg-indigo-50','border-indigo-300');
        btn.addEventListener('click', ()=>{ state.selectedShopId = s.id; state.selectedCampaignId = null; renderCampaignPills(); updateGating(); renderChosenSummary(); updateEditShopVisibility(); fillEditShopForm(); });
        els.shopPills.appendChild(btn);
      }
      els.campaignSection.classList.toggle('hidden', !state.selectedShopId);
    }

    function renderCampaignPills(){
      els.campaignPills.innerHTML = '';
      if (!state.selectedShopId){ els.campaignSection.classList.add('hidden'); return; }
      const camps = loadCamps(state.selectedShopId);
      for (const c of camps){
        const wrap = document.createElement('div'); wrap.className='relative group flex items-center';
        const btn = document.createElement('button'); btn.type='button'; btn.className='pill px-3 py-1 rounded-full border bg-white text-sm'; btn.textContent=c.name;
        if (c.id===state.selectedCampaignId) btn.classList.add('bg-indigo-50','border-indigo-300');
        btn.addEventListener('click', ()=>{ state.selectedCampaignId = c.id; applySettings(c.settings); loadDisplayOptionsFromMeta(); fillEditCampaignForm(); toast(`å·²å¥—ç”¨ DM æ–¹æ¡ˆã€Œ${c.name}ã€`); renderChosenSummary(); updateGating(); reloadPresets(); });
        // å° xï¼šåˆªé™¤ï¼ˆé¡¯ç¤ºæ–¼ hoverï¼‰
        const del = document.createElement('button'); del.type='button'; del.textContent='x'; del.title='åˆªé™¤'; del.className='ml-1 opacity-0 group-hover:opacity-100 text-slate-400 hover:text-rose-600 text-xs w-6 h-6 rounded-full inline-grid place-items-center';
        del.addEventListener('click', (e)=>{ e.stopPropagation(); if (!safeConfirm(`åˆªé™¤æ–¹æ¡ˆã€Œ${c.name}ã€ï¼Ÿ`)) return; const list=loadCamps(state.selectedShopId).filter(x=>x.id!==c.id); saveCamps(state.selectedShopId, list); if (state.selectedCampaignId===c.id) state.selectedCampaignId=null; renderCampaignPills(); renderChosenSummary(); updateGating(); reloadPresets(); });
        wrap.append(btn, del); els.campaignPills.appendChild(wrap);
      }
      // æœ‰é¸åº—å®¶æ™‚ä¸€å¾‹é¡¯ç¤º DM å€å¡Šï¼ˆå³ä½¿ç›®å‰æ²’æœ‰ä»»ä½•æ–¹æ¡ˆï¼‰ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥æ–°å¢
      els.campaignSection.classList.remove('hidden');
      // è‹¥ç›®å‰æ²’æœ‰ä»»ä½•æ–¹æ¡ˆï¼Œå”åŠ©å±•é–‹æ–°å¢è¡¨å–®
      const hasAny = camps.length>0;
      if (!hasAny && els.formAddCampaign) { els.formAddCampaign.classList.remove('hidden'); }
    }

    els.btnAddShopToggle.addEventListener('click', ()=>{ els.formAddShop.classList.toggle('hidden'); });
    els.btnCancelAddShop.addEventListener('click', ()=>{ els.formAddShop.classList.add('hidden'); els.formAddShop.reset(); });

    function updateEditShopVisibility(){
      const hasShop = !!state.selectedShopId;
      if (els.btnEditShopToggle) els.btnEditShopToggle.classList.toggle('hidden', !hasShop);
      if (els.btnDelShop) els.btnDelShop.classList.toggle('hidden', !hasShop);
    }
    function fillEditShopForm(){
      if (!els.formEditShop) return; const s = state.selectedShopId? findShopById(state.selectedShopId): null; if (!s) return;
      els.formEditShop.shopName.value = s.name || '';
      els.formEditShop.brandColor.value = s.brandColor || '#0ea5e9';
      const c = s.contact||{};
      els.formEditShop.contactPerson.value = c.person||'';
      els.formEditShop.contactPhone.value = c.phone||'';
      els.formEditShop.contactLine.value = c.line||'';
      els.formEditShop.contactFacebook.value = c.facebook||'';
      els.formEditShop.contactInstagram.value = c.instagram||'';
      els.formEditShop.contactAddress.value = c.address||'';
      els.formEditShop.contactWebsite.value = c.website||'';
    }

    els.btnEditShopToggle && els.btnEditShopToggle.addEventListener('click', ()=>{ if (!state.selectedShopId){ alert('è«‹å…ˆé¸æ“‡åº—å®¶'); return; } fillEditShopForm(); els.formEditShop.classList.toggle('hidden'); });
    els.btnCancelEditShop && els.btnCancelEditShop.addEventListener('click', ()=>{ els.formEditShop.classList.add('hidden'); });

    els.formAddShop.addEventListener('submit', async (e)=>{
      e.preventDefault(); if (!state.user){ alert('è«‹å…ˆç™»å…¥'); return; }
      const fd = new FormData(els.formAddShop);
      const name = (fd.get('shopName')||'').toString().trim(); if (!name){ alert('è«‹è¼¸å…¥åº—å'); return; }
      let logoDataUrl = '';
      const file = fd.get('shopLogo');
      if (file && file.size){ try{ logoDataUrl = await fileToDataUrl(file); } catch{} }
      const shop = {
        id: 'shop_'+uid(), name, logoDataUrl,
        brandColor: (fd.get('brandColor')||'').toString() || '',
        contact: {
          person: (fd.get('contactPerson')||'').toString(),
          phone: (fd.get('contactPhone')||'').toString(),
          line: (fd.get('contactLine')||'').toString(),
          facebook: (fd.get('contactFacebook')||'').toString(),
          instagram: (fd.get('contactInstagram')||'').toString(),
          address: (fd.get('contactAddress')||'').toString(),
          website: (fd.get('contactWebsite')||'').toString(),
        }
      };
      const list = loadShops(); list.unshift(shop); if (!saveShops(list)) return;
      els.formAddShop.reset(); els.formAddShop.classList.add('hidden');
      state.selectedShopId = shop.id; state.selectedCampaignId = null; renderShopPills(); renderCampaignPills(); updateGating(); renderChosenSummary();
      updateEditShopVisibility(); fillEditShopForm();
    });

    els.formEditShop && els.formEditShop.addEventListener('submit', async (e)=>{
      e.preventDefault(); if (!state.user){ alert('è«‹å…ˆç™»å…¥'); return; }
      if (!state.selectedShopId){ alert('è«‹å…ˆé¸æ“‡åº—å®¶'); return; }
      const fd = new FormData(els.formEditShop);
      const shops = loadShops(); const idx = shops.findIndex(x=>x.id===state.selectedShopId); if (idx<0) return;
      const cur = shops[idx];
      let logoDataUrl = cur.logoDataUrl || '';
      const file = fd.get('shopLogo'); if (file && file.size){ try{ logoDataUrl = await fileToDataUrl(file); }catch{} }
      const updated = {
        ...cur,
        name: (fd.get('shopName')||'').toString().trim() || cur.name,
        logoDataUrl,
        brandColor: (fd.get('brandColor')||'').toString() || cur.brandColor,
        contact: {
          person: (fd.get('contactPerson')||'').toString(),
          phone: (fd.get('contactPhone')||'').toString(),
          line: (fd.get('contactLine')||'').toString(),
          facebook: (fd.get('contactFacebook')||'').toString(),
          instagram: (fd.get('contactInstagram')||'').toString(),
          address: (fd.get('contactAddress')||'').toString(),
          website: (fd.get('contactWebsite')||'').toString(),
        }
      };
      shops[idx] = updated; saveShops(shops); els.formEditShop.classList.add('hidden'); renderShopPills(); renderChosenSummary(); renderDM(); toast('åº—å®¶è³‡æ–™å·²æ›´æ–°');
    });

    // åˆªé™¤åº—å®¶ï¼ˆåŒæ­¥åˆªé™¤å…¶æ–¹æ¡ˆèˆ‡è©²ç¯„åœé è¨­ï¼‰
    els.btnDelShop && els.btnDelShop.addEventListener('click', ()=>{
      if (!state.selectedShopId){ alert('è«‹å…ˆé¸æ“‡åº—å®¶'); return; }
      if (!safeConfirm('ç¢ºèªåˆªé™¤æ­¤åº—å®¶èˆ‡å…¶æ‰€æœ‰ DM æ–¹æ¡ˆï¼Ÿ')) return;
      const shops = loadShops().filter(x=> x.id!==state.selectedShopId);
      saveShops(shops);
      // åˆªé™¤è©²åº—å®¶çš„ campaigns èˆ‡ presets v5
      try{
        const uid = state.user?.id; if (uid){
          const ck = campsKey(state.selectedShopId); if (ck) localStorage.removeItem(ck);
          // æ¸…ç©ºæ­¤åº—å®¶åº•ä¸‹æ‰€æœ‰æ–¹æ¡ˆçš„ presets
          const camps = loadCamps(state.selectedShopId);
          for (const c of camps){ const pk = presetsV5Key(state.selectedShopId, c.id); if (pk) localStorage.removeItem(pk); }
        }
      }catch{}
      state.selectedShopId=null; state.selectedCampaignId=null; renderShopPills(); renderCampaignPills(); updateGating(); renderChosenSummary(); reloadPresets(); toast('å·²åˆªé™¤åº—å®¶');
    });

    els.btnAddCampaignToggle.addEventListener('click', ()=>{ els.formAddCampaign.classList.toggle('hidden'); });
    els.btnCancelAddCampaign.addEventListener('click', ()=>{ els.formAddCampaign.classList.add('hidden'); els.formAddCampaign.reset(); });
    function fillEditCampaignForm(){ if (!els.formEditCampaign) return; const c = state.selectedCampaignId? findCampById(state.selectedShopId, state.selectedCampaignId): null; if (!c){ els.formEditCampaign.classList.add('hidden'); return; } els.formEditCampaign.campaignName.value = c.name||''; els.formEditCampaign.classList.remove('hidden'); }

    els.formAddCampaign.addEventListener('submit', (e)=>{
      e.preventDefault(); if (!state.user){ alert('è«‹å…ˆç™»å…¥'); return; }
      if (!state.selectedShopId){ alert('è«‹å…ˆé¸æ“‡åº—å®¶'); return; }
      const fd = new FormData(els.formAddCampaign);
      const name = (fd.get('campaignName')||'').toString().trim(); if (!name){ alert('è«‹è¼¸å…¥æ–¹æ¡ˆåç¨±'); return; }
      const qrUrl = (fd.get('qrUrl')||'').toString().trim();
      const qrFile = fd.get('qrImage');
      const metaBase = { header:'', disclaimer:'', showShopName:true, showCampaignName:true, showContact:false, showNotes:false, notes:'', showBadge:false, badgeText:'é™æ™‚ç‰¹åƒ¹', qrDataUrl:'', showLogo:false, showQR:true };
      const camp = { id:'camp_'+uid(), name, settings: currentSettings(), meta: metaBase };
      (async ()=>{
        try{
          if (qrFile && qrFile.size){ 
            camp.meta.qrDataUrl = await fileToDataUrl(qrFile); 
            console.log('QRæ–‡ä»¶ä¸Šå‚³æˆåŠŸ');
          }
          else if (qrUrl){
            console.log('é–‹å§‹ç”ŸæˆQRï¼ŒURL:', qrUrl);
            if (typeof QRCode === 'undefined') {
              throw new Error('QRCodeåº«æœªè¼‰å…¥ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
            }
            const canvas = document.createElement('canvas');
            await QRCode.toCanvas(canvas, qrUrl, { width: 300, margin: 1, color: { dark: '#000000', light: null } });
            camp.meta.qrDataUrl = canvas.toDataURL('image/png');
            console.log('QRç”ŸæˆæˆåŠŸï¼Œæ•¸æ“šé•·åº¦:', camp.meta.qrDataUrl.length);
          }
        }catch(e){ 
          console.error('ç”¢ç”Ÿ/è¼‰å…¥ QR å¤±æ•—', e); 
          alert('QRç”Ÿæˆå¤±æ•—: ' + e.message);
        }
        const list = loadCamps(state.selectedShopId); list.unshift(camp); if (!saveCamps(state.selectedShopId, list)) return;
        els.formAddCampaign.reset(); els.formAddCampaign.classList.add('hidden');
        state.selectedCampaignId = camp.id; renderCampaignPills(); applySettings(camp.settings); loadDisplayOptionsFromMeta(); toast(`å·²å¥—ç”¨ DM æ–¹æ¡ˆã€Œ${camp.name}ã€`); renderChosenSummary(); updateGating(); reloadPresets();
      })();
    });

    // ç·¨è¼¯æ–¹æ¡ˆ
    els.btnCancelEditCampaign && els.btnCancelEditCampaign.addEventListener('click', ()=>{ els.formEditCampaign.classList.add('hidden'); });
    els.formEditCampaign && els.formEditCampaign.addEventListener('submit', async (e)=>{
      e.preventDefault(); if (!state.user){ alert('è«‹å…ˆç™»å…¥'); return; }
      if (!state.selectedShopId || !state.selectedCampaignId){ alert('è«‹å…ˆé¸æ“‡æ–¹æ¡ˆ'); return; }
      const fd = new FormData(els.formEditCampaign);
      const camps = loadCamps(state.selectedShopId); const idx = camps.findIndex(x=>x.id===state.selectedCampaignId); if (idx<0) return;
      const old = camps[idx];
      let qrDataUrl = old.meta?.qrDataUrl || '';
      const qrFile = fd.get('qrImage'); const qrUrl = (fd.get('qrUrl')||'').toString().trim();
      try{
        if (qrFile && qrFile.size){ 
          qrDataUrl = await fileToDataUrl(qrFile); 
          console.log('QRæ–‡ä»¶æ›´æ–°æˆåŠŸ');
        }
        else if (qrUrl){ 
          console.log('é–‹å§‹æ›´æ–°QRï¼ŒURL:', qrUrl);
          if (typeof QRCode === 'undefined') {
            throw new Error('QRCodeåº«æœªè¼‰å…¥ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
          }
          const canvas=document.createElement('canvas'); 
          await QRCode.toCanvas(canvas, qrUrl, { width:300, margin:1, color: { dark: '#000000', light: null } }); 
          qrDataUrl = canvas.toDataURL('image/png');
          console.log('QRæ›´æ–°æˆåŠŸï¼Œæ•¸æ“šé•·åº¦:', qrDataUrl.length);
        }
      }catch(e){
        console.error('æ›´æ–°QRå¤±æ•—', e);
        alert('QRæ›´æ–°å¤±æ•—: ' + e.message);
      }
      camps[idx] = { ...old, name: (fd.get('campaignName')||'').toString().trim()||old.name, meta: { showShopName:true, showCampaignName:true, showContact:false, showNotes:false, notes:'', showBadge:false, badgeText:'é™æ™‚ç‰¹åƒ¹', showLogo:false, showQR:true, ...(old.meta||{}), qrDataUrl } };
      saveCamps(state.selectedShopId, camps); toast('æ–¹æ¡ˆå·²æ›´æ–°'); renderCampaignPills(); loadDisplayOptionsFromMeta(); renderChosenSummary(); updateGating(); reloadPresets();
    });
    // æ–¹æ¡ˆåˆªé™¤ï¼ˆæŒ‰éˆ•ä½æ–¼è¡¨å–®å…§ï¼‰
    els.btnDelCampaign && els.btnDelCampaign.addEventListener('click', ()=>{
      if (!state.selectedShopId || !state.selectedCampaignId){ alert('è«‹å…ˆé¸æ“‡æ–¹æ¡ˆ'); return; }
      if (!safeConfirm('ç¢ºèªåˆªé™¤æ­¤æ–¹æ¡ˆï¼Ÿ')) return;
      const list = loadCamps(state.selectedShopId).filter(x=>x.id!==state.selectedCampaignId);
      saveCamps(state.selectedShopId, list); state.selectedCampaignId=null; els.formEditCampaign.classList.add('hidden'); renderCampaignPills(); renderChosenSummary(); updateGating(); reloadPresets();
    });

    // ===== Gatingï¼ˆæµç¨‹é–å®šï¼‰ =====
    function hasScopeReady(){ return !!(state.selectedShopId && state.selectedCampaignId); }
    function setCardLocked(card, locked){
      if (!card) return;
      card.classList.toggle('opacity-50', locked);
      const title = card.querySelector('.acc-title');
      const content = Array.from(card.children).filter(n=> n!==title);
      content.forEach(n=> n.style.pointerEvents = locked? 'none' : '');
    }

    function updateGating(){
      const disabled = !hasScopeReady();
      // æ¨£å¼å¡ã€é è¨­æ¨£å¼å¡ã€é¡¯ç¤ºé …ç›®å¡ï¼šåƒ…é–å…§å®¹ï¼Œä¸é–æ¨™é¡Œåˆ—
      setCardLocked(els.templateSelect.closest('.acc'), disabled);
      setCardLocked(els.presetList.closest('.acc'), disabled);
      setCardLocked(document.querySelector('[data-acc-key="dm-display"]'), disabled);
      // åŒ¯å‡º
      els.downloadPng.disabled = disabled; els.downloadPdf.disabled = disabled;
      els.downloadPng.classList.toggle('opacity-50', disabled); els.downloadPdf.classList.toggle('opacity-50', disabled);
    }

    function fakeLogin(provider){
      // ä¸€éµç™»å…¥ï¼šä¸ä½¿ç”¨ promptï¼Œé¿å…è¢«ç’°å¢ƒå°é–
      const email = `tester+${provider.toLowerCase()}@local`;
      setUser({ id: email, name: provider });
      reloadPresets();
    }

    els.loginGoogle.addEventListener('click', () => fakeLogin('Google'));
    els.loginFacebook.addEventListener('click', () => fakeLogin('Facebook'));
    els.loginLINE.addEventListener('click', () => fakeLogin('LINE'));

    // é‡ç½®æœ¬æ©Ÿè³‡æ–™ï¼ˆæ¸…ç©ºç›®å‰å¸³è™Ÿç›¸é—œçš„ shops/campaigns/presets/accordionï¼‰
    els.resetData.addEventListener('click', ()=>{
      try{
        if (!state.user){ localStorage.clear(); location.reload(); return; }
        const uid = state.user.id;
        Object.keys(localStorage).forEach(k=>{
          if (k.startsWith('dm-shops-v1:'+uid) || k.startsWith('dm-campaigns-v1:'+uid) || k.startsWith('dm-presets-v5:'+uid) || k.startsWith('dm-presets-v4:'+uid) || k.startsWith('dm-acc-v1:'+uid)){
            localStorage.removeItem(k);
          }
        });
        // ä¹Ÿåˆªé™¤æ‰€æœ‰è©²å¸³è™Ÿä¸‹å„åº—å®¶çš„ campaigns
        const shops = loadShops();
        for (const s of shops){ const k = `dm-campaigns-v1:${uid}:${s.id}`; localStorage.removeItem(k); }
        // é€€å‡ºç™»å…¥ï¼Œå›åˆ°åˆå§‹ç‹€æ…‹
        setUser(null); state.selectedShopId=null; state.selectedCampaignId=null; renderShopPills(); renderCampaignPills(); updateGating(); renderChosenSummary(); reloadPresets(); toast('å·²é‡ç½®æœ¬æ©Ÿè³‡æ–™');
      }catch(e){ console.error(e); toast('é‡ç½®å¤±æ•—ï¼Œè«‹æ‰‹å‹•æ¸…é™¤ç€è¦½å™¨å„²å­˜'); }
    });

    // é‡ç½®ç”¨æˆ¶æ•¸æ“šï¼ˆåƒ…é‡ç½®ä½¿ç”¨æ¬¡æ•¸å’Œä»˜è²»ç‹€æ…‹ï¼‰
    els.resetUser.addEventListener('click', ()=>{
      try{
        localStorage.removeItem('dm_user');
        initUser();
        toast('ç”¨æˆ¶æ•¸æ“šå·²é‡ç½®ï¼Œä½¿ç”¨æ¬¡æ•¸æ¢å¾©ç‚º3æ¬¡');
      }catch(e){ 
        console.error(e); 
        toast('é‡ç½®å¤±æ•—'); 
      }
    });

    // ===== åœ–ç‰‡è™•ç† =====
    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function productImageDom(p, isHighRes = false){
      if (!p?.imageDataUrl){
        return `<div class='w-full h-full grid place-items-center text-slate-400'>ç„¡å•†å“åœ–</div>`;
      }
      const bgSize = state.imgFit === 'contain' ? 'contain' : 'cover';
      const bgPos = ({center:'center', top:'top', bottom:'bottom', left:'left', right:'right'})[state.imgPos] || 'center';
      
      // ç‚ºä¹å®®æ ¼å’Œæ¸…å–®æä¾›é«˜è§£æåº¦åœ–ç‰‡è™•ç†
      if (isHighRes) {
        // ä½¿ç”¨é«˜è§£æåº¦èƒŒæ™¯åœ–ï¼Œç¢ºä¿å°å°ºå¯¸å®¹å™¨ä¹Ÿèƒ½æ¸…æ™°é¡¯ç¤º
        // æ·»åŠ å¤šé‡CSSå„ªåŒ–æå‡åœ–ç‰‡æ¸…æ™°åº¦
        return `<div class='w-full h-full' style="background-image:url('${p.imageDataUrl}');background-size:${bgSize};background-position:${bgPos};background-repeat:no-repeat;image-rendering: -webkit-optimize-contrast;image-rendering: crisp-edges;image-rendering: pixelated;transform: translateZ(0);backface-visibility: hidden;"></div>`;
      }
      
      // ä½¿ç”¨èƒŒæ™¯åœ–ç¢ºä¿ html2canvas ä¹Ÿèƒ½æ­£ç¢ºè£åˆ‡ï¼ˆèˆ‡é è¦½ä¸€è‡´ï¼šç½®ä¸­ã€æº¢å‡ºè£åˆ‡ã€æ¯”ä¾‹ä¸è®Šï¼‰
      return `<div class='w-full h-full' style="background-image:url('${p.imageDataUrl}');background-size:${bgSize};background-position:${bgPos};background-repeat:no-repeat;"></div>`;
    }

    // ===== AIæè¿°ç”Ÿæˆ =====
    function generateAIDescription(productName, price, originalPrice, imageDataUrl = null) {
      // åŸºæ–¼å•†å“åç¨±å’Œåƒ¹æ ¼ç”Ÿæˆå¸å¼•äººçš„æè¿°
      const descriptions = {
        // é£Ÿå“é¡
        'è‚‰': ['æ–°é®®ç›´é€ï¼Œå“è³ªä¿è­‰', 'åš´é¸é£Ÿæï¼Œå£æ„Ÿçµ•ä½³', 'ç‡Ÿé¤Šè±å¯Œï¼Œç¾å‘³å¥åº·'],
        'é›': ['é®®å«©å¤šæ±ï¼Œé¦™æ°£å››æº¢', 'å„ªè³ªè›‹ç™½è³ªä¾†æº', 'æ–™ç†ç°¡å–®ï¼Œç¾å‘³æ»¿åˆ†'],
        'ç‰›': ['é ‚ç´šè‚‰è³ªï¼Œå…¥å£å³åŒ–', 'è±å¯Œç‡Ÿé¤Šï¼Œå¥åº·é¦–é¸', 'æ–°é®®ç¾åˆ‡ï¼Œå“è³ªä¿è­‰'],
        'è±¬': ['è‚¥ç˜¦é©ä¸­ï¼Œå£æ„Ÿçµ•ä½³', 'æ–°é®®ç›´é€ï¼Œå“è³ªå„ªè‰¯', 'æ–™ç†å¤šæ¨£ï¼Œç¾å‘³æ»¿åˆ†'],
        'é­š': ['æ–°é®®æµ·å‘³ï¼Œç‡Ÿé¤Šè±å¯Œ', 'å„ªè³ªè›‹ç™½è³ªï¼Œå¥åº·é¦–é¸', 'é®®ç¾å¯å£ï¼Œå›å‘³ç„¡çª®'],
        'è¦': ['é®®ç”œQå½ˆï¼Œå£æ„Ÿçµ•ä½³', 'æ–°é®®æµ·å‘³ï¼Œç‡Ÿé¤Šè±å¯Œ', 'æ–™ç†ç°¡å–®ï¼Œç¾å‘³æ»¿åˆ†'],
        'è”¬èœ': ['æ–°é®®ç›´é€ï¼Œç‡Ÿé¤Šè±å¯Œ', 'æœ‰æ©Ÿç¨®æ¤ï¼Œå¥åº·é¦–é¸', 'æ¸…è„†çˆ½å£ï¼Œç¾å‘³å¥åº·'],
        'æ°´æœ': ['æ–°é®®ç¾æ‘˜ï¼Œé¦™ç”œå¯å£', 'ç‡Ÿé¤Šè±å¯Œï¼Œå¥åº·ç¾å‘³', 'å­£ç¯€é™å®šï¼Œå“è³ªä¿è­‰'],
        'ç‡’è‚‰': ['é¦™æ°£å››æº¢ï¼Œå£æ„Ÿçµ•ä½³', 'æ–°é®®è‚‰è³ªï¼Œç¾å‘³æ»¿åˆ†', 'ç‡’çƒ¤å¿…å‚™ï¼Œèšæœƒé¦–é¸'],
        'ç«é‹': ['æ¹¯é ­æ¿ƒéƒï¼Œé£Ÿæè±å¯Œ', 'æº«æš–ç¾å‘³ï¼Œèšé¤é¦–é¸', 'æ–°é®®é£Ÿæï¼Œå¥åº·ç¾å‘³'],
        'ä¾¿ç•¶': ['ç‡Ÿé¤Šå‡è¡¡ï¼Œç¾å‘³ä¾¿ç•¶', 'æ–°é®®ç¾åšï¼Œå¥åº·é¦–é¸', 'æ–¹ä¾¿ç¾å‘³ï¼Œä¸Šç­æ—æœ€æ„›'],
        'é£²æ–™': ['æ¸…æ¶¼è§£æ¸´ï¼Œå£æ„Ÿçµ•ä½³', 'å¤©ç„¶æˆåˆ†ï¼Œå¥åº·é¸æ“‡', 'å¤šç¨®å£å‘³ï¼Œæ»¿è¶³éœ€æ±‚'],
        
        // é£²å“é¡
        'èŒ¶': ['é¦™æ°£æ¿ƒéƒï¼Œå›ç”˜æ‚ é•·', 'ç²¾é¸èŒ¶è‘‰ï¼Œå“è³ªä¿è­‰', 'æ¸…é¦™æ€¡äººï¼Œæ”¾é¬†èº«å¿ƒ'],
        'å’–å•¡': ['é¦™é†‡æ¿ƒéƒï¼Œæç¥é†’è…¦', 'ç²¾é¸è±†å­ï¼Œå£æ„Ÿçµ•ä½³', 'é¦™æ°£å››æº¢ï¼Œå›å‘³ç„¡çª®'],
        'ç‰›å¥¶': ['é¦™æ¿ƒç´”æ­£ï¼Œç‡Ÿé¤Šè±å¯Œ', 'æ–°é®®ç›´é€ï¼Œå“è³ªä¿è­‰', 'å„ªè³ªè›‹ç™½è³ªï¼Œå¥åº·é¦–é¸'],
        'æœæ±': ['æ–°é®®ç¾æ¦¨ï¼Œç¶­ç”Ÿç´ è±å¯Œ', 'å¤©ç„¶æœé¦™ï¼Œå¥åº·ç¾å‘³', 'ç„¡æ·»åŠ ï¼Œç´”å¤©ç„¶'],
        'å¥¶èŒ¶': ['é¦™æ¿ƒæ»‘é †ï¼Œç”œèœœæ»‹å‘³', 'ç¶“å…¸å£å‘³ï¼Œäººæ°£é¦–é¸', 'é¦™æ°£å››æº¢ï¼Œå›å‘³ç„¡çª®'],
        
        // ç”œé»é¡
        'è›‹ç³•': ['ç¶¿å¯†å£æ„Ÿï¼Œé¦™ç”œå¯å£', 'ç²¾ç·»æ‰‹å·¥ï¼Œç¾å‘³æ»¿åˆ†', 'ç¯€æ…¶å¿…å‚™ï¼Œå¹¸ç¦æ»‹å‘³'],
        'é¤…ä¹¾': ['é¦™è„†å¯å£ï¼Œå›å‘³ç„¡çª®', 'æ‰‹å·¥è£½ä½œï¼Œå“è³ªä¿è­‰', 'ä¸‹åˆèŒ¶é¦–é¸ï¼Œç¾å‘³æ»¿åˆ†'],
        'å·§å…‹åŠ›': ['é¦™æ¿ƒæ»‘é †ï¼Œç”œèœœæ»‹å‘³', 'ç²¾é¸å¯å¯ï¼Œå£æ„Ÿçµ•ä½³', 'æµªæ¼«é¦–é¸ï¼Œå¹¸ç¦æ»¿åˆ†'],
        'å¸ƒä¸': ['æ»‘å«©å£æ„Ÿï¼Œé¦™ç”œå¯å£', 'æ‰‹å·¥è£½ä½œï¼Œç¾å‘³æ»¿åˆ†', 'ç”œé»é¦–é¸ï¼Œå¹¸ç¦æ»‹å‘³'],
        
        // æ—¥ç”¨å“é¡
        'æ¸…æ½”': ['å¼·æ•ˆæ¸…æ½”ï¼Œå®‰å…¨ç„¡æ¯’', 'ç’°ä¿é…æ–¹ï¼Œå¥åº·é¦–é¸', 'å»æ±¡åŠ›å¼·ï¼Œä½¿ç”¨æ–¹ä¾¿'],
        'ä¿é¤Š': ['æº«å’Œé…æ–¹ï¼Œå‘µè­·è‚Œè†š', 'å¤©ç„¶æˆåˆ†ï¼Œå¥åº·ç¾éº—', 'å°ˆæ¥­å“è³ªï¼Œæ•ˆæœé¡¯è‘—'],
        'å±…å®¶': ['å¯¦ç”¨ç¾è§€ï¼Œæå‡ç”Ÿæ´»å“è³ª', 'ç²¾é¸æè³ªï¼Œè€ç”¨å¯é ', 'è¨­è¨ˆè²¼å¿ƒï¼Œä½¿ç”¨ä¾¿åˆ©'],
        'æ–‡å…·': ['å¯¦ç”¨ç¾è§€ï¼Œå­¸ç¿’å¿…å‚™', 'ç²¾é¸æè³ªï¼Œæ›¸å¯«æµæš¢', 'è¨­è¨ˆè²¼å¿ƒï¼Œä½¿ç”¨ä¾¿åˆ©'],
        
        // é›»å­ç”¢å“é¡
        'æ‰‹æ©Ÿ': ['åŠŸèƒ½å¼·å¤§ï¼Œæ€§èƒ½å„ªè¶Š', 'æ™‚å°šè¨­è¨ˆï¼Œç§‘æŠ€æ„Ÿåè¶³', 'æ™ºèƒ½ç”Ÿæ´»ï¼Œä¾¿åˆ©é¦–é¸'],
        'é›»è…¦': ['é«˜æ•ˆèƒ½è™•ç†ï¼Œå·¥ä½œåˆ©å™¨', 'å°ˆæ¥­å“è³ªï¼Œå€¼å¾—ä¿¡è³´', 'ç§‘æŠ€å‰µæ–°ï¼Œæå‡æ•ˆç‡'],
        'è€³æ©Ÿ': ['éŸ³è³ªæ¸…æ™°ï¼Œèˆ’é©ä½©æˆ´', 'ç„¡ç·šä¾¿åˆ©ï¼ŒéŸ³æ¨‚äº«å—', 'é«˜å“è³ªéŸ³æ•ˆï¼Œè½è¦ºç››å®´']
      };
      
      // æ ¹æ“šå•†å“åç¨±æ‰¾åˆ°åŒ¹é…çš„é—œéµè©
      let matchedKeywords = [];
      for (const [keyword, descs] of Object.entries(descriptions)) {
        if (productName.includes(keyword)) {
          matchedKeywords = descs;
          break;
        }
      }
      
      // å¦‚æœæ²’æœ‰åŒ¹é…åˆ°ï¼Œä½¿ç”¨é€šç”¨æè¿°
      if (matchedKeywords.length === 0) {
        matchedKeywords = [
          'ç²¾é¸å•†å“ï¼Œå“è³ªä¿è­‰',
          'å„ªè³ªé¸æ“‡ï¼Œå€¼å¾—ä¿¡è³´',
          'å¯¦ç”¨ç¾è§€ï¼Œç‰©è¶…æ‰€å€¼',
          'æ–°é®®ç›´é€ï¼Œå“è³ªå„ªè‰¯',
          'å°ˆæ¥­å“è³ªï¼Œæ•ˆæœé¡¯è‘—',
          'ç†±é–€å•†å“ï¼Œäººæ°£é¦–é¸',
          'é™æ™‚ç‰¹åƒ¹ï¼ŒéŒ¯éå¯æƒœ',
          'å“è³ªå„ªè‰¯ï¼Œå£ç¢‘æ¨è–¦'
        ];
      }
      
      // éš¨æ©Ÿé¸æ“‡ä¸€å€‹æè¿°
      const baseDesc = matchedKeywords[Math.floor(Math.random() * matchedKeywords.length)];
      
      // æ ¹æ“šåƒ¹æ ¼æ·»åŠ ä¿ƒéŠ·å…ƒç´ 
      let finalDesc = baseDesc;
      if (originalPrice && originalPrice > price) {
        const discount = Math.round((1 - price / originalPrice) * 100);
        if (discount >= 30) {
          finalDesc += `ï¼Œé™æ™‚${discount}æŠ˜å„ªæƒ `;
        } else if (discount >= 20) {
          finalDesc += `ï¼Œç‰¹åƒ¹å„ªæƒ ä¸­`;
        } else if (discount >= 10) {
          finalDesc += `ï¼Œå„ªæƒ åƒ¹`;
        }
      }
      
      // æ ¹æ“šåƒ¹æ ¼ç¯„åœæ·»åŠ ä¸åŒçš„æè¿°
      if (price > 0) {
        if (price >= 1000) {
          finalDesc += 'ï¼Œé«˜ç«¯å“è³ª';
        } else if (price >= 500) {
          finalDesc += 'ï¼Œä¸­é«˜æª”é¸æ“‡';
        } else if (price >= 100) {
          finalDesc += 'ï¼Œç¶“æ¿Ÿå¯¦æƒ ';
        } else {
          finalDesc += 'ï¼Œè¶…å€¼å„ªæƒ ';
        }
      }
      
      // æ·»åŠ ä¸€äº›å¸¸è¦‹çš„ä¿ƒéŠ·è©å½™
      const promotions = ['', 'ï¼Œæ•¸é‡æœ‰é™', 'ï¼Œå”®å®Œç‚ºæ­¢', 'ï¼ŒéŒ¯éå¯æƒœ', 'ï¼Œç«‹å³æ¶è³¼'];
      const randomPromo = promotions[Math.floor(Math.random() * promotions.length)];
      
      return finalDesc + randomPromo;
    }

    // ===== å•†å“è¼¸å…¥ =====
    let pendingImage = null;
    els.pickImg.addEventListener('click', () => els.imgInput.click());
    
    // AIæè¿°ç”ŸæˆæŒ‰éˆ•
    const aiDescBtn = document.getElementById('ai-desc-btn');
    if (aiDescBtn) {
      aiDescBtn.addEventListener('click', () => {
        const form = aiDescBtn.closest('form');
        const nameInput = form.querySelector('input[name="name"]');
        const priceInput = form.querySelector('input[name="price"]');
        const originalPriceInput = form.querySelector('input[name="originalPrice"]');
        const descTextarea = form.querySelector('textarea[name="desc"]');
        
        const productName = nameInput.value.trim();
        const price = parseFloat(priceInput.value) || 0;
        const originalPrice = parseFloat(originalPriceInput.value) || 0;
        
        if (!productName) {
          alert('è«‹å…ˆè¼¸å…¥å•†å“åç¨±');
          return;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        aiDescBtn.textContent = 'ç”Ÿæˆä¸­...';
        aiDescBtn.disabled = true;
        
        // æ¨¡æ“¬AIç”Ÿæˆéç¨‹ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­å¯ä»¥èª¿ç”¨çœŸå¯¦çš„AI APIï¼‰
        setTimeout(() => {
          const aiDescription = generateAIDescription(productName, price, originalPrice, pendingImage);
          descTextarea.value = aiDescription;
          
          // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
          aiDescBtn.textContent = 'AI';
          aiDescBtn.disabled = false;
          
          // é¡¯ç¤ºæˆåŠŸæç¤º
          showToast('AIæè¿°ç”Ÿæˆå®Œæˆï¼');
        }, 800);
      });
    }
    
    // æ‰¹é‡AIæè¿°ç”Ÿæˆ
    const batchAiDescBtn = document.getElementById('batch-ai-desc');
    if (batchAiDescBtn) {
      batchAiDescBtn.addEventListener('click', () => {
        // æ‰¾å‡ºæ²’æœ‰æè¿°çš„å•†å“
        const productsWithoutDesc = state.products.filter(p => !p.desc || p.desc.trim() === '');
        
        if (productsWithoutDesc.length === 0) {
          showToast('æ‰€æœ‰å•†å“éƒ½å·²æœ‰æè¿°ï¼');
          return;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        batchAiDescBtn.textContent = `æ­£åœ¨ç”Ÿæˆ ${productsWithoutDesc.length} å€‹æè¿°...`;
        batchAiDescBtn.disabled = true;
        
        // æ‰¹é‡ç”Ÿæˆæè¿°
        let completed = 0;
        productsWithoutDesc.forEach((product, index) => {
          setTimeout(() => {
            const aiDescription = generateAIDescription(product.name, product.price, product.originalPrice, product.imageDataUrl);
            product.desc = aiDescription;
            completed++;
            
            // ç«‹å³æ›´æ–°è©²è¡Œçš„é¡¯ç¤º
            const textarea = document.querySelector(`textarea[data-id="${product.id}"]`);
            if (textarea) {
              textarea.value = aiDescription;
              textarea.style.backgroundColor = '#f0f9ff';
              setTimeout(() => {
                textarea.style.backgroundColor = '';
              }, 1000);
            }
            
            if (completed === productsWithoutDesc.length) {
              // å…¨éƒ¨å®Œæˆ
              batchAiDescBtn.textContent = 'ç‚ºæ‰€æœ‰å•†å“ç”ŸæˆAIæè¿°';
              batchAiDescBtn.disabled = false;
              showToast(`æˆåŠŸç‚º ${productsWithoutDesc.length} å€‹å•†å“ç”Ÿæˆæè¿°ï¼`);
              
              // é‡æ–°æ¸²æŸ“DMé è¦½
              renderDM();
            }
          }, index * 200); // æ¯å€‹å•†å“é–“éš”200msï¼Œé¿å…å¤ªå¿«
        });
      });
    }
    
    // ç‚ºé¸ä¸­å•†å“ç”ŸæˆAIæè¿°
    const aiDescSelectedBtn = document.getElementById('ai-desc-selected');
    if (aiDescSelectedBtn) {
      aiDescSelectedBtn.addEventListener('click', () => {
        // æ‰¾å‡ºé¸ä¸­ä¸”æ²’æœ‰æè¿°çš„å•†å“
        const selectedProducts = state.products.filter(p => 
          state.selection.has(p.id) && (!p.desc || p.desc.trim() === '')
        );
        
        if (selectedProducts.length === 0) {
          showToast('é¸ä¸­çš„å•†å“éƒ½å·²æœ‰æè¿°ï¼');
          return;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        aiDescSelectedBtn.textContent = `æ­£åœ¨ç”Ÿæˆ ${selectedProducts.length} å€‹æè¿°...`;
        aiDescSelectedBtn.disabled = true;
        
        // æ‰¹é‡ç”Ÿæˆæè¿°
        let completed = 0;
        selectedProducts.forEach((product, index) => {
          setTimeout(() => {
            const aiDescription = generateAIDescription(product.name, product.price, product.originalPrice, product.imageDataUrl);
            product.desc = aiDescription;
            completed++;
            
            // ç«‹å³æ›´æ–°è©²è¡Œçš„é¡¯ç¤º
            const textarea = document.querySelector(`textarea[data-id="${product.id}"]`);
            if (textarea) {
              textarea.value = aiDescription;
              textarea.style.backgroundColor = '#f0f9ff';
              setTimeout(() => {
                textarea.style.backgroundColor = '';
              }, 1000);
            }
            
            if (completed === selectedProducts.length) {
              // å…¨éƒ¨å®Œæˆ
              aiDescSelectedBtn.textContent = 'ç‚ºé¸ä¸­å•†å“ç”Ÿæˆ';
              aiDescSelectedBtn.disabled = false;
              showToast(`æˆåŠŸç‚º ${selectedProducts.length} å€‹é¸ä¸­å•†å“ç”Ÿæˆæè¿°ï¼`);
              
              // é‡æ–°æ¸²æŸ“DMé è¦½
              renderDM();
            }
          }, index * 200); // æ¯å€‹å•†å“é–“éš”200msï¼Œé¿å…å¤ªå¿«
        });
      });
    }
    
    els.imgInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        pendingImage = await fileToDataUrl(file);
        els.imgName.textContent = file.name;
      } catch(err){ console.error(err); }
    });

    els.form.addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(els.form);
      const product = {
        id: uid(),
        name: (fd.get('name')||'').toString().trim(),
        price: Number(fd.get('price')||0),
        originalPrice: (fd.get('originalPrice')===''? '' : Number(fd.get('originalPrice')||0)),
        desc: (fd.get('desc')||'').toString().trim(),
        imageDataUrl: pendingImage || '',
      };
      if (!product.name || !product.price) { alert('è«‹å¡«å•†å“åèˆ‡å”®åƒ¹'); return; }
      state.products.unshift(product);
      pendingImage = null; els.imgName.textContent = 'å°šæœªé¸æ“‡'; els.form.reset();
      renderTable(); renderDM();
    });

    els.csvInput.addEventListener('change', (e) => {
      const file = e.target.files[0]; if (!file) return;
      Papa.parse(file, {
        header: true, skipEmptyLines: true,
        complete: async (res) => {
          for (const row of res.data) {
            let imageDataUrl = '';
            if (row.imageUrl) {
              try {
                const resp = await fetch(row.imageUrl);
                const blob = await resp.blob();
                imageDataUrl = await fileToDataUrl(blob);
              } catch(err){ console.warn('è¼‰åœ–å¤±æ•—', err); }
            }
            state.products.push({ id: uid(), name: (row.name||'').toString(), price: Number(row.price||0), originalPrice: row.originalPrice? Number(row.originalPrice):'', desc: (row.desc||'').toString(), imageDataUrl });
          }
          renderTable(); renderDM();
        }
      });
    });

    // ä¸‹è¼‰æ‰¹é‡åŒ¯å…¥ç¯„æœ¬ï¼ˆCSVï¼‰
    const btnTpl = document.getElementById('btn-download-template');
    if (btnTpl) btnTpl.addEventListener('click', ()=>{
      const header = '\uFEFFname,price,originalPrice,desc,imageUrl\n';
      const headerCn = 'å•†å“åç¨±,å”®åƒ¹,åŸåƒ¹,å•†å“èªªæ˜,åœ–ç‰‡é€£çµç¶²å€(è‹¥ç„¡å‰‡å…å¡«)\n';
      const blob = new Blob([header+headerCn], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='dm-import-template.csv'; a.click(); setTimeout(()=> URL.revokeObjectURL(url), 1000);
    });

    // ===== å•†å“è¡¨æ ¼ =====
    function renderTable(){
      els.tbody.innerHTML = '';
      for (const p of state.products) {
        const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-slate-50';
        tr.innerHTML = `
          <td class="p-2 align-top"><input type="checkbox" data-id="${p.id}" ${state.selection.has(p.id)?'checked':''}></td>
          <td class="p-2 align-top">
            <div class="inline-block rounded-lg overflow-hidden cursor-pointer group" data-reupload="${p.id}" style="width:4rem;height:4rem;min-width:4rem">
              ${p.imageDataUrl? `<img src="${p.imageDataUrl}" class="w-full h-full object-cover" />` : `<div class='w-full h-full grid place-items-center text-slate-400'>ç„¡å•†å“åœ–</div>`}
            </div>
          </td>
          <td class="p-2 align-top"><input class="w-48 border rounded-lg p-1" value="${escapeHtml(p.name)}" data-edit="name" data-id="${p.id}"></td>
          <td class="p-2 align-top"><input class="w-24 border rounded-lg p-1" type="number" value="${p.price}" data-edit="price" data-id="${p.id}"></td>
          <td class="p-2 align-top"><input class="w-24 border rounded-lg p-1" type="number" value="${p.originalPrice||''}" data-edit="originalPrice" data-id="${p.id}"></td>
          <td class="p-2 align-top">
            <div class="flex gap-1">
              <textarea class="flex-1 border rounded-lg p-1" rows="2" data-edit="desc" data-id="${p.id}">${escapeHtml(p.desc)}</textarea>
              <button type="button" class="px-2 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors ai-desc-single" data-id="${p.id}" title="AIç”Ÿæˆæè¿°">AI</button>
            </div>
          </td>`;
        els.tbody.appendChild(tr);
      }

      // å–®å€‹å•†å“AIæè¿°ç”Ÿæˆ
      els.tbody.querySelectorAll('.ai-desc-single').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const productId = e.target.dataset.id;
          const product = state.products.find(p => p.id === productId);
          if (!product) return;
          
          const textarea = e.target.previousElementSibling;
          
          // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
          e.target.textContent = 'ç”Ÿæˆä¸­...';
          e.target.disabled = true;
          
          // ç”ŸæˆAIæè¿°
          setTimeout(() => {
            const aiDescription = generateAIDescription(product.name, product.price, product.originalPrice, product.imageDataUrl);
            textarea.value = aiDescription;
            product.desc = aiDescription;
            
            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            e.target.textContent = 'AI';
            e.target.disabled = false;
            
            // ç«‹å³æ›´æ–°é¡¯ç¤º
            textarea.style.backgroundColor = '#f0f9ff';
            setTimeout(() => {
              textarea.style.backgroundColor = '';
            }, 1000);
            
            showToast('AIæè¿°ç”Ÿæˆå®Œæˆï¼');
          }, 600);
        });
      });
      
      els.tbody.querySelectorAll('input[type="checkbox"]').forEach(chk => {
        chk.addEventListener('change', (e)=>{
          if (!hasScopeReady()){
            alert('è«‹å…ˆé¸åº—å®¶èˆ‡ DM æ–¹æ¡ˆ');
            e.target.checked = false; return;
          }
          const id = e.target.getAttribute('data-id');
          if (e.target.checked) state.selection.add(id); else state.selection.delete(id);
          renderDM();
        });
      });

      // é»ç¸®åœ–é‡æ–°ä¸Šå‚³
      els.tbody.querySelectorAll('[data-reupload]').forEach(box=>{
        box.addEventListener('click', async ()=>{
          const id = box.getAttribute('data-reupload');
          const input = document.createElement('input'); input.type='file'; input.accept='image/*';
          input.onchange = async (ev)=>{
            const file = ev.target.files[0]; if (!file) return;
            const url = await fileToDataUrl(file);
            const p = state.products.find(x=>x.id===id); if (!p) return; p.imageDataUrl = url; renderTable(); renderDM();
          };
          input.click();
        });
      });

      els.tbody.querySelectorAll('[data-edit]').forEach(inp => {
        inp.addEventListener('input', (e)=>{
          const id = e.target.getAttribute('data-id');
          const key = e.target.getAttribute('data-edit');
          const p = state.products.find(x=>x.id===id); if (!p) return;
          if (key==='price' || key==='originalPrice') p[key] = e.target.value===''? '' : Number(e.target.value);
          else p[key] = e.target.value;
          renderDM();
        });
      });

      const selAll = document.getElementById('select-all');
      if (selAll){
        selAll.checked = state.products.length>0 && state.products.every(p=> state.selection.has(p.id));
        selAll.addEventListener('change', ()=>{
          if (selAll.checked){ state.products.forEach(p=> state.selection.add(p.id)); }
          else { state.selection.clear(); }
          renderTable(); renderDM();
        });
      }
    }

    // ===== æ¨¡æ¿æ¸²æŸ“ =====
    els.templateSelect.addEventListener('change', ()=>{ state.template = els.templateSelect.value; renderDM(); });
    els.fitSelect.addEventListener('change', ()=>{ state.imgFit = els.fitSelect.value; renderDM(); });
    els.posSelect.addEventListener('change', ()=>{ state.imgPos = els.posSelect.value; renderDM(); });
    els.ratioSelect.addEventListener('change', ()=>{ state.imgRatio = els.ratioSelect.value; renderDM(); });
    els.gridCardH.addEventListener('change', ()=>{ state.gridCardH = Number(els.gridCardH.value); renderDM(); });
    els.gridFill.addEventListener('change', ()=>{ state.gridFill = els.gridFill.checked; renderDM(); });
    els.gridImgFrac.addEventListener('change', ()=>{ state.gridImgFrac = Number(els.gridImgFrac.value); renderDM(); });

    function renderDM(){
      const wrap = els.dmCanvas; wrap.innerHTML='';
      const selected = state.products.filter(p=> state.selection.has(p.id));
      const items = selected.length? selected : state.products;
      if (state.template==='single') renderPagedSingle(wrap, items);
      else if (state.template==='singleFull') renderPagedSingleFull(wrap, items);
      else if (state.template==='grid9') renderPagedGrid9(wrap, items);
      else if (state.template==='list') renderPagedList(wrap, items);
    }

    function createPage(){ const page = document.createElement('div'); page.className='dm-page relative'; return page; }

    function renderPagedGrid9(root, items){
      for (let i=0;i<Math.max(1, Math.ceil(items.length/9)); i++){
        const page = createPage();
        const slice = items.slice(i*9, i*9+9);
        renderGrid9(page, slice);
        root.appendChild(page);
      }
    }
    function renderPagedList(root, items){
      const pageSize = 12;
      for (let i=0;i<Math.max(1, Math.ceil(items.length/pageSize)); i++){
        const page = createPage(); renderList(page, items.slice(i*pageSize, i*pageSize+pageSize)); root.appendChild(page);
      }
    }
    function renderPagedSingle(root, items){
      const pageSize = 1; for (let i=0;i<Math.max(1, Math.ceil(items.length/pageSize)); i++){ const page=createPage(); renderSingle(page, items[i]); root.appendChild(page);} }
    function renderPagedSingleFull(root, items){
      const pageSize = 1; for (let i=0;i<Math.max(1, Math.ceil(items.length/pageSize)); i++){ const page=createPage(); renderSingleFull(page, items[i]); root.appendChild(page);} }

    function getActiveShop(){ return state.selectedShopId ? findShopById(state.selectedShopId) : null; }
    function getActiveMeta(){
      if (!hasScopeReady()) return { showShopName:true, showCampaignName:true, showContact:false, showNotes:false, notes:'', showBadge:false, badgeText:'é™æ™‚ç‰¹åƒ¹', qrDataUrl:'', showLogo:false, showQR:true, borderStyle:'none', borderColor:'#e2e8f0', backgroundColor:'#ffffff' };
      const c = findCampById(state.selectedShopId, state.selectedCampaignId);
      const meta = c?.meta || { showShopName:true, showCampaignName:true, showContact:false, showNotes:false, notes:'', showBadge:false, badgeText:'é™æ™‚ç‰¹åƒ¹', qrDataUrl:'', showLogo:false, showQR:true, borderStyle:'none', borderColor:'#e2e8f0', backgroundColor:'#ffffff' };
      return meta;
    }

    function getBorderStyle(meta) {
      if (!meta.borderStyle || meta.borderStyle === 'none') return '';
      const borderWidth = meta.borderStyle === 'double' ? '3px' : '2px';
      return `border: ${borderWidth} ${meta.borderStyle} ${meta.borderColor || '#e2e8f0'};`;
    }

    function getBackgroundStyle(meta) {
      if (!meta.backgroundColor || meta.backgroundColor === '#ffffff') return '';
      return `background-color: ${meta.backgroundColor};`;
    }

    // å‰µå»ºä¸€å€‹å®Œå…¨ç¨ç«‹çš„è¼¸å‡ºç¯€é»ï¼Œä½¿ç”¨åŸå§‹å°ºå¯¸ï¼Œä¸å—é è¦½ç¸®æ”¾å½±éŸ¿
    function createExportNode(sourceNode) {
      try {
        // å‰µå»ºä¸€å€‹æ–°çš„divä½œç‚ºè¼¸å‡ºå®¹å™¨ï¼Œä½¿ç”¨åŸå§‹DMå°ºå¯¸
        const exportNode = document.createElement('div');
        exportNode.style.width = '1080px';
        exportNode.style.height = '1350px';
        exportNode.style.position = 'relative';
        exportNode.style.overflow = 'hidden';
        exportNode.style.backgroundColor = '#ffffff';
        exportNode.style.boxSizing = 'border-box';
        exportNode.style.transform = 'none'; // ç¢ºä¿æ²’æœ‰ç¸®æ”¾è®Šæ›
        exportNode.style.transformOrigin = 'top left';
        
        // å®Œå…¨è¤‡è£½æºç¯€é»çš„å…§å®¹
        exportNode.innerHTML = sourceNode.innerHTML;
        
        // å¼·åˆ¶é‡æ–°è¨ˆç®—æ‰€æœ‰æ¨£å¼ï¼Œç¢ºä¿ä½¿ç”¨åŸå§‹å°ºå¯¸
        const allElements = exportNode.querySelectorAll('*');
        allElements.forEach(el => {
          // ç§»é™¤æ‰€æœ‰å¯èƒ½å½±éŸ¿è¼¸å‡ºçš„classå’Œstyle
          el.className = el.className.replace(/scale-\d+|transform|transition/g, '');
          el.style.transform = 'none';
          el.style.transition = 'none';
          
          // å¼·åˆ¶è¨­å®šé—œéµæ¨£å¼
          if (el.tagName === 'IMG') {
            el.style.objectFit = state.imgFit === 'contain' ? 'contain' : 'cover';
            el.style.objectPosition = state.imgPos || 'center';
            el.style.width = '100%';
            el.style.height = '100%';
            el.style.display = 'block';
            el.style.maxWidth = 'none';
            el.style.maxHeight = 'none';
          }
          
          // ç¢ºä¿æ‰€æœ‰å®¹å™¨ä½¿ç”¨æ­£ç¢ºçš„å°ºå¯¸
          if (el.style.aspectRatio) {
            el.style.width = '100%';
            el.style.height = '100%';
          }
          
          // å¼·åˆ¶è¨­å®šæ‰€æœ‰å¯èƒ½å½±éŸ¿ä½ˆå±€çš„æ¨£å¼
          if (el.classList.contains('absolute')) {
            el.style.position = 'absolute';
          }
          if (el.classList.contains('relative')) {
            el.style.position = 'relative';
          }
          if (el.classList.contains('flex')) {
            el.style.display = 'flex';
          }
          if (el.classList.contains('grid')) {
            el.style.display = 'grid';
          }
        });
        
        // è‡¨æ™‚æ·»åŠ åˆ°DOMä¸­é€²è¡Œæ¸²æŸ“ï¼Œç¢ºä¿åœ¨è¦–è¦ºç¯„åœå¤–
        exportNode.style.position = 'fixed';
        exportNode.style.top = '-9999px';
        exportNode.style.left = '-9999px';
        exportNode.style.zIndex = '-9999';
        exportNode.style.visibility = 'hidden';
        document.body.appendChild(exportNode);
        
        console.log('Export node created successfully'); // èª¿è©¦ä¿¡æ¯
        return exportNode;
      } catch (error) {
        console.error('Error creating export node:', error);
        throw error;
      }
    }
    
    // æ¸…ç†è‡¨æ™‚ç¯€é»
    function cleanupExportNode(node) {
      if (node && node.parentNode) {
        node.parentNode.removeChild(node);
      }
    }
    
    // æ¸¬è©¦å‡½æ•¸ï¼šé©—è­‰è¼¸å‡ºç¯€é»å°ºå¯¸
    function testExportNodeSize(node) {
      const rect = node.getBoundingClientRect();
      console.log('Export node size:', {
        width: rect.width,
        height: rect.height,
        expectedWidth: 1080,
        expectedHeight: 1350,
        isCorrect: rect.width === 1080 && rect.height === 1350
      });
      return rect.width === 1080 && rect.height === 1350;
    }

    function renderSingle(root, p){
      const node = document.createElement('div'); node.className='absolute inset-0 flex flex-col';
      if (!p) { node.innerHTML = `<div class='m-auto text-slate-400'>è«‹å…ˆæ–°å¢å•†å“ä¸¦å‹¾é¸</div>`; root.appendChild(node); return; }
      const meta = getActiveMeta(); const shop = getActiveShop(); const brand = shop?.brandColor || '#0ea5e9';
      node.innerHTML = `
        <div class="h-20 px-10 flex items-center justify-between relative">
          <div class="text-3xl font-extrabold tracking-wide">${meta.showShopName? `<span class='mr-3 inline-flex items-center gap-2'><span class='inline-block w-2.5 h-2.5 rounded-full' style='background:${brand}'></span>${escapeHtml(shop?.name||'')}</span>`:''}</div>
          ${meta.showCampaignName? `<div class='absolute left-1/2 -translate-x-1/2 text-xl font-semibold text-slate-800 pointer-events-none'>${escapeHtml(findCampById(state.selectedShopId, state.selectedCampaignId)?.name||'')}</div>`:''}
          <div class="flex items-center gap-2">
            ${meta.showLogo && shop?.logoDataUrl? `<div class='flex flex-col items-end gap-1'><img src='${shop.logoDataUrl}' class='w-14 h-14 object-contain rounded-md border bg-white'/></div>`:''}
        </div>
          </div>
          <div class="grid grid-cols-2 gap-8 px-10 py-6 flex-1">
          <div class="bg-white rounded-2xl shadow overflow-hidden" style="aspect-ratio:${state.imgRatio}; ${getBorderStyle(meta)}${getBackgroundStyle(meta)}">${productImageDom(p)}</div>
          <div class="flex flex-col justify-start">
              <div class="flex items-start justify-between gap-3 mb-4">
                <div class="text-4xl font-extrabold leading-tight flex-1" style="line-height: 1.1;">${escapeHtml(p.name)}</div>
                ${meta.showBadge? `<div class=\"px-3 py-1 rounded-full bg-rose-600 text-white text-sm flex-none ml-2\">${escapeHtml(meta.badgeText||'é™æ™‚ç‰¹åƒ¹')}</div>`:''}
        </div>
            <div class="text-3xl font-extrabold mb-3">${priceTag(p.price)} ${p.originalPrice? `<span class='text-lg text-slate-400 line-through align-middle ml-2'>${priceTag(p.originalPrice)}</span>`:''}</div>
            <div class="text-lg text-slate-600 mb-3 flex-1" style="line-height: 1.3;">${escapeHtml(p.desc||'')}</div>
            <div class="text-sm text-slate-500 mb-4">* åƒ¹æ ¼è®Šå‹•ä»¥ç•¶ä¸‹æ¨™ç¤ºç‚ºæº–</div>
              ${renderSingleSupplement(meta, shop)}
        </div>
        </div>
        <div class="h-16 bg-slate-900/95 text-white flex items-center justify-center text-sm tracking-widest px-4">
          ${renderFooterInfo(meta, shop)}
        </div>`;
      root.appendChild(node);
    }

    function renderSingleFull(root, p){
      const node = document.createElement('div'); node.className='absolute inset-0';
      if (!p) { node.innerHTML = `<div class='w-full h-full grid place-items-center text-slate-400'>è«‹å…ˆæ–°å¢å•†å“ä¸¦å‹¾é¸</div>`; root.appendChild(node); return; }
      const bgSize = state.imgFit==='contain'?'contain':'cover';
      const bgPos = ({center:'center', top:'top', bottom:'bottom', left:'left', right:'right'})[state.imgPos] || 'center';
      const meta = getActiveMeta(); const shop = getActiveShop(); const brand = shop?.brandColor || '#0ea5e9';
      node.innerHTML = `
        <div class="absolute inset-0">${p.imageDataUrl?`<div class='w-full h-full' style="background-image:url('${p.imageDataUrl}');background-size:${bgSize};background-position:${bgPos};background-repeat:no-repeat;"></div>`:`<div class='w-full h-full bg-gradient-to-br from-slate-200 to-slate-100'></div>`}</div>
        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/25 to-transparent"></div>
        <div class="absolute inset-x-0 top-0 h-20 px-10 flex items-center justify-between text-white relative">
          <div class="text-3xl font-extrabold tracking-wide drop-shadow">${meta.showShopName? `<span class='mr-3 inline-flex items-center gap-2'><span class='inline-block w-2.5 h-2.5 rounded-full' style='background:${brand}'></span>${escapeHtml(shop?.name||'')}</span>`:''}</div>
          ${meta.showCampaignName? `<div class='absolute left-1/2 -translate-x-1/2 text-xl font-semibold text-white/90 pointer-events-none drop-shadow'>${escapeHtml(findCampById(state.selectedShopId, state.selectedCampaignId)?.name||'')}</div>`:''}
          <div class="flex items-center gap-2">
            ${meta.showLogo && shop?.logoDataUrl? `<div class='flex flex-col items-end gap-1'><img src='${shop.logoDataUrl}' class='w-14 h-14 object-contain rounded-md border bg-white/90'/></div>`:''}
        </div>
          </div>
        <div class="absolute inset-x-0 bottom-0 p-8 flex flex-col">
          <div class="max-w-[90%] text-white drop-shadow mb-4">
            <div class="flex items-start justify-between gap-3 mb-2">
              <div class="text-4xl font-extrabold leading-tight flex-1" style="line-height: 1.1;">${escapeHtml(p.name)}</div>
              ${meta.showBadge? `<div class="px-3 py-1 rounded-full bg-rose-600 text-white text-sm flex-none ml-2">${escapeHtml(meta.badgeText||'é™æ™‚ç‰¹åƒ¹')}</div>`:''}
          </div>
            <div class="text-lg opacity-95 mb-3" style="line-height: 1.3;">${escapeHtml(p.desc||'')}</div>
          </div>
          <div class="flex items-end gap-4 mb-4">
            <div class="text-6xl font-extrabold text-white drop-shadow">${priceTag(p.price)}</div>
            ${p.originalPrice? `<div class='text-2xl text-white/80 line-through drop-shadow'>${priceTag(p.originalPrice)}</div>`:''}
          </div>
          <div class="flex-1">${renderNotesBlock(meta,'glass', shop)}</div>
          <div class="mt-4 h-14 bg-white/92 rounded-2xl px-6 flex items-center justify-center text-slate-900 text-sm tracking-widest shadow">${renderFooterInfo(meta, shop)}</div>
        </div>`;
      root.appendChild(node);
    }

    function renderGrid9(root, arr){
      const node = document.createElement('div'); node.className='absolute inset-0 flex flex-col';
      const meta = getActiveMeta(); const shop = getActiveShop(); const brand = shop?.brandColor || '#0ea5e9';
      // ä¼°ç®—ä¸‹æ–¹è£œå……å€é«˜åº¦ï¼Œå‹•æ…‹å£“ç¸®å¡ç‰‡é«˜åº¦é¿å…äº’ç›¸è¦†è“‹
      const hasSupp = !!( (meta.showContact && (buildContactLines(shop).length>0)) || (meta.showNotes && (meta.notes||'').trim()!=='') || (meta.qrDataUrl && meta.showQR !== false) );
      const suppH = hasSupp ? 140 : 0; // è¿‘ä¼¼è£œå……å€é«˜åº¦
      const headerH = 80; // h-20
      const footerH = 64; // h-16
      const verticalGap = 24; // gap-6
      const pageH = 1350;
      const paddingBottom = 8; // pb-2
      const gridAvail = pageH - headerH - footerH - suppH - paddingBottom - 16; // 16 ç‚ºé ç•™
      const rowGaps = verticalGap * 2;
      const perCardH = Math.max(160, Math.min(state.gridCardH, Math.floor((gridAvail - rowGaps)/3)));

      node.innerHTML = `
        <div class="h-20 px-10 flex items-center justify-between relative">
          <div class="text-3xl font-extrabold">${meta.showShopName? `<span class='mr-3 inline-flex items-center gap-2'><span class='inline-block w-2.5 h-2.5 rounded-full' style='background:${brand}'></span>${escapeHtml(shop?.name||'')}</span>`:''}</div>
          ${meta.showCampaignName? `<div class='absolute left-1/2 -translate-x-1/2 text-xl font-semibold text-slate-800 pointer-events-none'>${escapeHtml(findCampById(state.selectedShopId, state.selectedCampaignId)?.name||'')}</div>`:''}
          <div class="flex items-center gap-2">
            ${meta.showBadge? `<div class="px-3 py-1 rounded-full bg-rose-600 text-white text-sm">${escapeHtml(meta.badgeText||'é™æ™‚ç‰¹åƒ¹')}</div>`:''}
            ${meta.showLogo && shop?.logoDataUrl? `<div class='flex flex-col items-end gap-1'><img src='${shop.logoDataUrl}' class='w-14 h-14 object-contain rounded-md border bg-white'/></div>`:''}
        </div>
        </div>
        <div class="grid grid-cols-3 gap-6 px-10 pb-6 place-content-start" style="min-height:${perCardH*3 + rowGaps}px"></div>
        <div class="mt-6 px-10 pb-2">
          <div class="grid grid-cols-12 gap-4 items-start">
            <div class="col-span-6">${(function(){ const lines = meta.showContact? buildContactLines(getActiveShop()):[]; return lines.length? `<div class='bg-white rounded-2xl px-6 py-3 text-xs text-slate-700 shadow space-y-1'>${lines.map(l=>`<div>${escapeHtml(l)}</div>`).join('')}</div>`:''; })()}</div>
            <div class="col-span-4">${meta.showNotes && (meta.notes||'').trim()!=='' ? `<div class='bg-white rounded-2xl px-6 py-3 text-sm text-slate-800 shadow'>${escapeHtml(meta.notes)}</div>`:''}</div>
            <div class="col-span-2 flex justify-end">${(function(){ 
              const hasQR = !!(meta.qrDataUrl); 
              const showQR = meta.showQR !== false; // ç°¡åŒ–æ¢ä»¶ï¼Œé è¨­é¡¯ç¤º
              return hasQR && showQR ? `<img src='${meta.qrDataUrl}' class='w-24 h-24 object-contain rounded-lg border'/>` : ''; 
            })()}</div>
          </div>
        </div>
        <div class="h-16 bg-slate-900 text-white flex items-center justify-center text-sm tracking-widest px-4">${renderFooterInfo(meta, shop)}</div>`;
      const grid = node.children[1];
      const a = arr.slice(0,9); if (state.gridFill) { while (a.length<9) a.push(null); }
      for (const p of a){
        const card = document.createElement('div'); card.className='bg-white rounded-2xl shadow overflow-hidden flex flex-col'; card.style.height = perCardH+'px'; card.style.cssText += getBorderStyle(meta) + getBackgroundStyle(meta);
        if (!p){ card.innerHTML = `<div class='flex-1 grid place-items-center text-slate-300'>ç©ºç™½</div>`; }
        else {
          const imgH = Math.round(perCardH * 0.55); // æ¸›å°‘åœ–ç‰‡æ¯”ä¾‹åˆ°55%
          const textH = perCardH - imgH; // å‰©é¤˜ç©ºé–“çµ¦æ–‡å­—
          card.innerHTML = `
            <div class="flex-none bg-slate-100 overflow-hidden high-res-img" style="height:${imgH}px">${productImageDom(p, true)}</div>
            <div class="p-3 flex-1 flex flex-col" style="height:${textH}px;">
              <div class="text-base font-bold mb-1" style="line-height: 1.1;">${escapeHtml(p.name)}</div>
              <div class="text-sm text-slate-600 mb-2 flex-1" style="line-height: 1.2;">${escapeHtml(p.desc||'')}</div>
              <div class="flex items-baseline gap-2 mt-auto">
                <div class="text-xl font-extrabold">${priceTag(p.price)}</div>
                ${p.originalPrice? `<div class='text-sm text-slate-400 line-through'>${priceTag(p.originalPrice)}</div>`:''}
              </div>
            </div>`;
        }
        grid.appendChild(card);
      }
      root.appendChild(node);
    }

    function renderList(root, arr){
      const node = document.createElement('div'); node.className='absolute inset-0 p-10 flex flex-col';
      const meta = getActiveMeta(); const shop = getActiveShop(); const brand = shop?.brandColor || '#0ea5e9';
      node.innerHTML = `
        <div class="text-4xl font-extrabold mb-4 relative flex items-center justify-between">
          <div>${escapeHtml(shop?.name||'')}</div>
          ${meta.showCampaignName? `<span class='absolute left-1/2 -translate-x-1/2 text-xl font-semibold text-slate-800 pointer-events-none'>${escapeHtml(findCampById(state.selectedShopId, state.selectedCampaignId)?.name||'')}</span>`:''}
          <div class="flex items-center gap-2">
            ${meta.showBadge? `<div class="px-3 py-1 rounded-full bg-rose-600 text-white text-sm">${escapeHtml(meta.badgeText||'é™æ™‚ç‰¹åƒ¹')}</div>`:''}
            ${meta.showLogo && shop?.logoDataUrl? `<img src='${shop.logoDataUrl}' class='w-12 h-12 object-contain rounded-md border bg-white'/>`:''}
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow divide-y" style="${getBorderStyle(meta)}${getBackgroundStyle(meta)}"></div>
        <div class="mt-4">${renderNotesBlock(meta,'light', shop,'mt-2')}</div>
        <div class="mt-auto text-xs text-slate-500">${renderFooterInfo(meta, shop)}</div>`;
      const list = node.children[1];
      const max = 12; const items = arr.slice(0, max);
      for (const p of items){
        const row = document.createElement('div'); row.className='grid grid-cols-12 items-start gap-2 p-4';
        row.innerHTML = `
          <div class="col-span-2"><div class='rounded-xl overflow-hidden high-res-img' style='width:4.5rem; aspect-ratio:${state.imgRatio}; ${getBorderStyle(meta)}${getBackgroundStyle(meta)}'>${productImageDom(p, true)}</div></div>
          <div class="col-span-5 text-lg font-semibold" style="line-height: 1.2;">${escapeHtml(p?.name||'å•†å“')}</div>
          <div class="col-span-3 text-sm text-slate-600" style="line-height: 1.3;">${escapeHtml(p?.desc||'')}</div>
          <div class="col-span-2 text-right flex flex-col justify-start">
            <div class="text-3xl font-extrabold">${priceTag(p?.price||0)}</div>
            ${p?.originalPrice? `<div class='text-sm text-slate-400 line-through'>${priceTag(p.originalPrice)}</div>`:''}
          </div>`;
        list.appendChild(row);
      }
      root.appendChild(node);
    }

    function renderFooterInfo(meta, shop){
      return 'æƒæ QR ç«‹åˆ»ä¸‹å–®ï½œ@yourshop';
    }

    function buildContactLines(shop){
      const c = (shop&&shop.contact)||{};
      const map = [
        ['person','è¯çµ¡äºº'],
        ['phone','é›»è©±'],
        ['line','LINE'],
        ['facebook','Facebook'],
        ['instagram','Instagram'],
        ['address','åœ°å€'],
        ['website','ç¶²å€'],
      ];
      const lines = [];
      for (const [key,label] of map){
        const v = (c[key]||'').toString().trim(); if (!v) continue; lines.push(`${label}ï¼š${v}`);
      }
      return lines;
    }

    function renderNotesBlock(meta, theme, shop, extraClass){
      const hasNotes = !!(meta.showNotes && (meta.notes||'').trim()!=='');
      const contactLines = meta.showContact ? buildContactLines(shop) : [];
      const showContact = !!(meta.showContact && contactLines.length);
      const hasQR = !!(meta.qrDataUrl||'');
      const showQR = meta.showQR !== false; // ç°¡åŒ–æ¢ä»¶ï¼Œé è¨­é¡¯ç¤º
      if (!hasNotes && !showContact && !(hasQR && showQR)) return '';
      const note = hasNotes? escapeHtml(meta.notes||'') : '';
      const contactDom = showContact? `<div class='text-xs text-slate-600 mt-2 space-y-1'>${contactLines.map(l=>`<div>${escapeHtml(l)}</div>`).join('')}</div>` : '';
      const qr = (hasQR && showQR)? `<img src='${meta.qrDataUrl}' alt='QR' class='w-24 h-24 object-contain ml-4 rounded-lg border'/>` : '';
      const base = theme==='glass' ? 'bg-white/40 backdrop-blur-sm text-slate-900' : 'bg-white text-slate-800';
      const extra = extraClass? ` ${extraClass}` : '';
      return `<div class='${base} rounded-2xl px-6 py-3 flex items-center justify-between shadow${extra}'>
        <div class='text-sm pr-4'>${note}${contactDom}</div>
        ${qr}
      </div>`;
    }

    // å–®å“ï¼šå³å´æ¬„è£œå……å€ï¼ˆä¸Šï¼šè¯çµ¡ï¼›ä¸­ï¼šèªªæ˜ï¼›å³ï¼šQRï¼‰
    function renderSingleSupplement(meta, shop){
      const hasNotes = !!(meta.showNotes && (meta.notes||'').trim()!=='');
      const contactLines = meta.showContact ? buildContactLines(shop) : [];
      const hasContact = contactLines.length>0;
      const hasQR = !!(meta.qrDataUrl||'');
      const showQR = meta.showQR !== false; // ç°¡åŒ–æ¢ä»¶ï¼Œé è¨­é¡¯ç¤º
      if (!hasNotes && !hasContact && !(hasQR && showQR)) return '';
      const contactDom = hasContact? `<div class='text-xs text-slate-600 space-y-1'>${contactLines.map(l=>`<div>${escapeHtml(l)}</div>`).join('')}</div>`:'';
      const notesDom = hasNotes? `<div class='mt-2 text-sm text-slate-700'>${escapeHtml(meta.notes||'')}</div>`:'';
      const qrDom = (hasQR && showQR)? `<img src='${meta.qrDataUrl}' alt='QR' class='w-28 h-28 object-contain rounded-lg border'/>`:'';
      return `<div class='mt-4 grid grid-cols-3 gap-4 items-start'>
        <div class='col-span-2'>${contactDom}${!hasNotes && hasContact? '': notesDom}</div>
        <div class='col-span-1 flex justify-end'>${qrDom}</div>
      </div>`;
    }

    // ===== åŒ¯å‡º =====
    function prepareForExport() {
      // æš«æ™‚ç§»é™¤ç¸®æ”¾ï¼Œç¢ºä¿è¼¸å‡ºæ™‚æ˜¯åŸå§‹å°ºå¯¸
      const originalTransform = els.scaleWrap.style.transform;
      els.scaleWrap.style.transform = 'scale(1)';
      return () => {
        // æ¢å¾©åŸå§‹ç¸®æ”¾
        els.scaleWrap.style.transform = originalTransform;
      };
    }

    // ç²å–ä¸‹è¼‰é é¢ç¯„åœ
    function getDownloadPageRange() {
      const range = els.downloadRange.value;
      const allPages = els.dmCanvas.children.length ? Array.from(els.dmCanvas.children) : [els.dmCanvas];
      const totalPages = allPages.length;
      
      switch(range) {
        case 'current':
          return [0]; // åªä¸‹è¼‰ç¬¬ä¸€é 
        case 'custom':
          const start = parseInt(els.startPage.value) || 1;
          const end = parseInt(els.endPage.value) || totalPages;
          const startIdx = Math.max(0, start - 1);
          const endIdx = Math.min(totalPages - 1, end - 1);
          return Array.from({length: endIdx - startIdx + 1}, (_, i) => startIdx + i);
        case 'all':
        default:
          return Array.from({length: totalPages}, (_, i) => i);
      }
    }

    // ä¸‹è¼‰ç¯„åœé¸æ“‡äº‹ä»¶
    els.downloadRange.addEventListener('change', ()=>{
      const range = els.downloadRange.value;
      els.customRange.classList.toggle('hidden', range !== 'custom');
    });

    els.downloadPng.addEventListener('click', async ()=>{
      console.log('PNG download clicked');
      if (!hasScopeReady()) { alert('è«‹å…ˆé¸åº—å®¶èˆ‡ DM æ–¹æ¡ˆ'); return; }
      
      // æª¢æŸ¥ä½¿ç”¨é™åˆ¶
      if (!checkUsageLimit()) {
        showPaymentModal();
        return;
      }
      
      // å¢åŠ ä½¿ç”¨æ¬¡æ•¸
      incrementUsage();
      
      try {
        const shop = findShopById(state.selectedShopId)?.name||'shop';
        const camp = findCampById(state.selectedShopId, state.selectedCampaignId)?.name||'campaign';
        const pageNodes = els.dmCanvas.querySelectorAll('.dm-page');
        const allPages = pageNodes.length ? Array.from(pageNodes) : [els.dmCanvas];
        const pageIndices = getDownloadPageRange();
        
        console.log('Starting PNG download, pages:', pageIndices);
        
        // ç§»é™¤ç¸®æ”¾
        const originalTransform = els.scaleWrap.style.transform;
        els.scaleWrap.style.transform = 'scale(1)';
        await new Promise(r => setTimeout(r, 100));
        
        // å¦‚æœåªæœ‰ä¸€é ï¼Œç›´æ¥ä¸‹è¼‰
        if (pageIndices.length === 1) {
          const page = allPages[pageIndices[0]];
          const canvas = await html2canvas(page, { 
            backgroundColor: '#ffffff', 
            scale: 4, // æé«˜è§£æåº¦åˆ°4å€ï¼Œç‰¹åˆ¥é‡å°ä¹å®®æ ¼å’Œæ¸…å–®çš„å°åœ–ç‰‡
            useCORS: true,
            allowTaint: true,
            logging: false
          });
          
          const a = document.createElement('a'); 
          a.href = canvas.toDataURL('image/png', 1.0); 
          a.download = `${shop}-${camp}-${Date.now()}-p${pageIndices[0]+1}.png`; 
          a.click();
        } else {
          // å¤šé ä¸‹è¼‰ï¼Œå‰µå»ºZIPæª”æ¡ˆ
          const JSZip = window.JSZip;
          if (!JSZip) {
            // å¦‚æœæ²’æœ‰JSZipï¼Œé€ä¸€ä¸‹è¼‰
            for (const i of pageIndices) {
              const page = allPages[i];
              const canvas = await html2canvas(page, { 
                backgroundColor: '#ffffff', 
                scale: 4, // æé«˜è§£æåº¦åˆ°4å€ï¼Œç‰¹åˆ¥é‡å°ä¹å®®æ ¼å’Œæ¸…å–®çš„å°åœ–ç‰‡
                useCORS: true,
                allowTaint: true,
                logging: false
              });
              
              const a = document.createElement('a'); 
              a.href = canvas.toDataURL('image/png', 1.0); 
              a.download = `${shop}-${camp}-${Date.now()}-p${i+1}.png`; 
              a.click();
              
              // å»¶é²é¿å…ç€è¦½å™¨é˜»æ“‹
              if (i < pageIndices.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 500));
              }
            }
          } else {
            // ä½¿ç”¨JSZipå‰µå»ºå£“ç¸®æª”
            const zip = new JSZip();
            
            for (const i of pageIndices) {
              const page = allPages[i];
              const canvas = await html2canvas(page, { 
                backgroundColor: '#ffffff', 
                scale: 4, // æé«˜è§£æåº¦åˆ°4å€ï¼Œç‰¹åˆ¥é‡å°ä¹å®®æ ¼å’Œæ¸…å–®çš„å°åœ–ç‰‡
                useCORS: true,
                allowTaint: true,
                logging: false
              });
              
              const base64 = canvas.toDataURL('image/png', 1.0).split(',')[1];
              zip.file(`page-${i+1}.png`, base64, { base64: true });
            }
            
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(zipBlob);
            a.download = `${shop}-${camp}-${Date.now()}.zip`;
            a.click();
            URL.revokeObjectURL(a.href);
          }
        }
        
        // æ¢å¾©åŸå§‹ç¸®æ”¾
        els.scaleWrap.style.transform = originalTransform;
        
        console.log('PNG download completed');
      } catch (error) {
        console.error('PNG download error:', error);
        alert('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
      }
    });

    els.downloadPdf.addEventListener('click', async ()=>{
      console.log('PDF download clicked');
      if (!hasScopeReady()) { alert('è«‹å…ˆé¸åº—å®¶èˆ‡ DM æ–¹æ¡ˆ'); return; }
      
      // æª¢æŸ¥ä½¿ç”¨é™åˆ¶
      if (!checkUsageLimit()) {
        showPaymentModal();
        return;
      }
      
      // å¢åŠ ä½¿ç”¨æ¬¡æ•¸
      incrementUsage();
      
      try {
      const { jsPDF } = window.jspdf;
        const shop = findShopById(state.selectedShopId)?.name||'shop';
        const camp = findCampById(state.selectedShopId, state.selectedCampaignId)?.name||'campaign';
        const pageNodes = els.dmCanvas.querySelectorAll('.dm-page');
        const allPages = pageNodes.length ? Array.from(pageNodes) : [els.dmCanvas];
        const pageIndices = getDownloadPageRange();
        
        console.log('Starting PDF download, pages:', pageIndices);
        
        // ç§»é™¤ç¸®æ”¾
        const originalTransform = els.scaleWrap.style.transform;
        els.scaleWrap.style.transform = 'scale(1)';
        await new Promise(r => setTimeout(r, 100));
        
        // é€é æ¸²æŸ“ï¼Œä¸¦ä»¥æ¯é å¯¦éš›canvaså°ºå¯¸å»ºç«‹PDFé 
        let pdf = null;
        for (let i = 0; i < pageIndices.length; i++) {
          const pageIndex = pageIndices[i];
          const page = allPages[pageIndex];
          
          console.log(`Processing PDF page ${i+1}/${pageIndices.length}`);
          
          const canvas = await html2canvas(page, { 
            backgroundColor: '#ffffff', 
            scale: 4, // æé«˜è§£æåº¦åˆ°4å€ï¼Œç‰¹åˆ¥é‡å°ä¹å®®æ ¼å’Œæ¸…å–®çš„å°åœ–ç‰‡
            useCORS: true,
            allowTaint: true,
            logging: false
          });
          
          console.log('PDF Canvas created, size:', canvas.width, 'x', canvas.height);
          
          const imgData = canvas.toDataURL('image/png', 1.0);
          
          // ç¬¬ä¸€é æ™‚ï¼Œä»¥canvaså¯¦éš›å°ºå¯¸å»ºç«‹PDFæ–‡ä»¶
          if (!pdf) {
            pdf = new jsPDF({ unit: 'px', format: [canvas.width, canvas.height], orientation: 'portrait' });
          } else {
            pdf.addPage([canvas.width, canvas.height], 'portrait');
          }
          // ä»¥åŸå°ºå¯¸æ”¾å…¥ï¼Œé¿å…ä»»ä½•æ‹‰ä¼¸
          pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        }
        
        if (pdf) pdf.save(`${shop}-${camp}-${Date.now()}.pdf`);
        
        // æ¢å¾©åŸå§‹ç¸®æ”¾
        els.scaleWrap.style.transform = originalTransform;
        
        console.log('PDF download completed');
      } catch (error) {
        console.error('PDF download error:', error);
        alert('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
      }
    });

    // ===== é è¦½ç¸®æ”¾ =====
    function applyScale(){
      if (state.preview.fit){
        const pad = 16; const w = els.previewWrap.clientWidth - pad*2; const s = Math.min(1, w/1080);
        state.preview.scale = s; els.zoomRange.value = s.toFixed(2); els.zoomVal.textContent = Math.round(s*100)+'%';
      }
      els.scaleWrap.style.transform = `scale(${state.preview.scale})`;
    }
    window.addEventListener('resize', ()=>{ if (state.preview.fit) applyScale(); });
    els.zoomFit.addEventListener('click', ()=>{ state.preview.fit=true; applyScale(); });
    els.zoomBtns.forEach(btn=> btn.addEventListener('click', ()=>{ state.preview.fit=false; state.preview.scale = Number(btn.dataset.z); els.zoomRange.value = state.preview.scale; els.zoomVal.textContent = Math.round(state.preview.scale*100)+'%'; applyScale(); }));
    els.zoomRange.addEventListener('input', (e)=>{ state.preview.fit=false; state.preview.scale = Number(e.target.value); els.zoomVal.textContent = Math.round(state.preview.scale*100)+'%'; applyScale(); });

    // ===== é è¨­æ¨£å¼ï¼ˆå¸³è™Ÿå„²å­˜ï¼‰ =====
    const PRESET_KEY_PREFIX = 'dm-presets-v4:'; // æ¯å€‹å¸³è™Ÿä¸€ä»½ï¼ˆåªè®€ç”¨ï¼‰

    function defaultPresets(){
      return [
        { id: uid(), name: 'å–®å“å·¦å³ç‰ˆ', pinned:false, settings:{ template:'single', imgFit:'cover', imgPos:'center', imgRatio:'4/5', gridCardH:360, gridFill:true, gridImgFrac:0.6 }},
        { id: uid(), name: 'å–®å“æ»¿ç‰ˆèƒŒæ™¯', pinned:false, settings:{ template:'singleFull', imgFit:'cover', imgPos:'center', imgRatio:'4/5', gridCardH:360, gridFill:true, gridImgFrac:0.6 }},
        { id: uid(), name: 'ä¹å®®æ ¼', pinned:false, settings:{ template:'grid9', imgFit:'cover', imgPos:'center', imgRatio:'4/5', gridCardH:360, gridFill:true, gridImgFrac:0.6 }},
        { id: uid(), name: 'æ¸…å–®å¼', pinned:false, settings:{ template:'list', imgFit:'cover', imgPos:'center', imgRatio:'4/5', gridCardH:360, gridFill:true, gridImgFrac:0.6 }},
      ];
    }

    function storageKeyV4(){ return state.user ? PRESET_KEY_PREFIX + state.user.id : null; }

    function loadPresets(){
      // æœªç™»å…¥æˆ–å°šæœªé¸æ“‡ç¯„åœï¼šåƒ…é¡¯ç¤ºå…§å»ºé è¨­
      if (!state.user || !hasScopeReady()) return defaultPresets();
      const keyV5 = presetsV5Key(state.selectedShopId, state.selectedCampaignId);
      try {
        const raw = keyV5 ? localStorage.getItem(keyV5) : null;
        const arr = raw ? JSON.parse(raw) : [];
        if (Array.isArray(arr) && arr.length>0) return arr;
      } catch(err){ console.warn('è®€å– v5 é è¨­å¤±æ•—', err); }
      // fallbackï¼šé¡¯ç¤ºå…§å»ºé è¨­ï¼ˆä¹Ÿå¯é¸æ“‡è®€ v4ï¼Œä½†ä¸å¯«å›ï¼‰
      return defaultPresets();
    }

    function savePresets(list){
      if (!state.user){ alert('è«‹å…ˆç™»å…¥å¸³è™Ÿæ‰èƒ½å„²å­˜æ¨£å¼'); return false; }
      if (!hasScopeReady()){ return false; }
      const key = presetsV5Key(state.selectedShopId, state.selectedCampaignId);
      try { localStorage.setItem(key, JSON.stringify(list)); return true; }
      catch(err){ console.error('å¯«å…¥å¤±æ•—', err); alert('å„²å­˜å¤±æ•—ï¼šç€è¦½å™¨å¯èƒ½å°é–äº†å„²å­˜ç©ºé–“'); return false; }
    }

    let presets = [];

    // åˆªé™¤æ¨£å¼ï¼ˆé›†ä¸­è™•ç†ï¼‰ï¼šæˆåŠŸå›å‚³ true
    function deletePresetById(id){
      if (!state.user) { try{ alert('è«‹å…ˆç™»å…¥ä»¥åˆªé™¤'); }catch(_){} return false; }
      const before = presets.length;
      presets = presets.filter(x=>x.id !== id);
      const saved = savePresets(presets);
      renderPresetButtons();
      return saved && presets.length === before - 1;
    }

    // åˆªé™¤ç¢ºèªå¾®æµ®å±¤ï¼ˆé¿å…ç€è¦½å™¨ confirm è¢«å°é–ï¼‰
    let delBubble = null;
    function closeDelBubble(){ if (delBubble){ delBubble.remove(); delBubble=null; } }
    function openDelBubble(anchorBtn, id, name){
      closeDelBubble();
      if (!state.user){ try{ alert('è«‹å…ˆç™»å…¥ä»¥åˆªé™¤'); }catch(_){} return; }
      const box = document.createElement('div');
      box.className = 'absolute z-20 -right-2 top-full mt-1 bg-white border rounded-xl shadow p-2 flex items-center gap-2 text-sm del-pop';
      box.dataset.id = id;
      box.innerHTML = `<span>åˆªé™¤ã€Œ${escapeHtml(name||'æ¨£å¼')}ã€ï¼Ÿ</span>
        <button class="px-2 py-1 rounded-lg bg-rose-600 text-white" data-act="confirm">åˆªé™¤</button>
        <button class="px-2 py-1 rounded-lg border" data-act="cancel">å–æ¶ˆ</button>`;
      const host = anchorBtn.parentElement; host.style.position = 'relative'; host.appendChild(box); delBubble = box;
      box.querySelector('[data-act="confirm"]').addEventListener('click', (e)=>{ e.stopPropagation(); e.preventDefault(); deletePresetById(id); closeDelBubble(); });
      box.querySelector('[data-act="cancel"]').addEventListener('click', (e)=>{ e.stopPropagation(); e.preventDefault(); closeDelBubble(); });
      setTimeout(()=> document.addEventListener('click', (ev)=>{ if (!box.contains(ev.target)) closeDelBubble(); }, { once:true }), 0);
    }

    function currentSettings(){
      return {
        template: state.template, imgFit: state.imgFit, imgPos: state.imgPos, imgRatio: state.imgRatio,
        gridCardH: state.gridCardH, gridFill: state.gridFill, gridImgFrac: state.gridImgFrac,
      };
    }

    function applySettings(s){ if (!s) return; state.template=s.template??state.template; els.templateSelect.value=state.template; state.imgFit=s.imgFit??state.imgFit; els.fitSelect.value=state.imgFit; state.imgPos=s.imgPos??state.imgPos; els.posSelect.value=state.imgPos; state.imgRatio=s.imgRatio??state.imgRatio; els.ratioSelect.value=state.imgRatio; state.gridCardH=s.gridCardH??state.gridCardH; els.gridCardH.value=String(state.gridCardH); state.gridFill=s.gridFill??state.gridFill; els.gridFill.checked=!!state.gridFill; state.gridImgFrac=s.gridImgFrac??state.gridImgFrac; els.gridImgFrac.value=String(state.gridImgFrac); renderDM(); }

    function sortPresetsForView(list){ return list.slice().sort((a,b)=> (b.pinned?1:0)-(a.pinned?1:0)); }

    function renderPresetButtons(){
      const box = els.presetList; box.innerHTML='';
      const display = sortPresetsForView(presets);
      if (!display.length){ box.innerHTML = `<span class='text-xs text-slate-400'>å°šç„¡æ¨£å¼ï¼Œç™»å…¥å¾Œå¯æ–°å¢ã€‚</span>`; return; }
      for (const p of display){
        const wrap = document.createElement('div'); wrap.className='relative group flex items-center';
        const btn = document.createElement('button'); btn.type='button'; btn.className='pill px-3 py-1 rounded-full border bg-white text-sm'; btn.textContent=p.name; btn.title='é»ä¸€ä¸‹å¥—ç”¨';
        btn.addEventListener('click', (e)=>{ e.stopPropagation(); applySettings(p.settings); openPresetMenu(wrap, p); });
        const del = document.createElement('button'); del.type='button'; del.dataset.del = p.id; del.dataset.name = p.name; del.className='ml-1 opacity-0 group-hover:opacity-100 text-slate-400 hover:text-rose-600 text-xs w-6 h-6 rounded-full inline-grid place-items-center'; del.textContent='x'; del.title='åˆªé™¤';
        del.addEventListener('click', (e)=>{ e.stopPropagation(); e.preventDefault(); openDelBubble(del, p.id, p.name); });
        wrap.append(btn, del); box.appendChild(wrap);
      }
    }

    // äº‹ä»¶ä»£ç†å‚™æ´ï¼šç¢ºä¿ä»»ä½• data-del é»æ“Šéƒ½èƒ½åˆªé™¤ï¼ˆé¿å…æŸäº›ç’°å¢ƒç›´ç¶ listener å¤±æ•ˆï¼‰
    els.presetList.addEventListener('click', (ev)=>{
      const t = ev.target.closest('[data-del]');
      if (!t) return;
      ev.stopPropagation(); ev.preventDefault();
      openDelBubble(t, t.getAttribute('data-del'), t.getAttribute('data-name') || '');
    });

    // é‡˜é¸é¸å–®
    let openMenuEl=null; let menuTimer=null;
    function closePresetMenu(){ if (openMenuEl){ openMenuEl.remove(); openMenuEl=null; } if (menuTimer){ clearTimeout(menuTimer); menuTimer=null; } }
    function openPresetMenu(anchor, preset){
      closePresetMenu();
      if (!state.user) return; // æœªç™»å…¥ä¸é¡¯ç¤ºé¸å–®
      const menu = document.createElement('div');
      menu.className = 'absolute left-0 top-full mt-1 z-10 bg-white border rounded-xl shadow text-sm overflow-hidden';
      const item = document.createElement('button'); item.type='button'; item.className='px-3 py-1 hover:bg-slate-50 w-full text-left'; item.textContent = preset.pinned? 'å–æ¶ˆé‡˜é¸' : 'ğŸ“Œ é‡˜é¸åˆ°æœ€å‰';
      item.addEventListener('click', (e)=>{ e.stopPropagation(); preset.pinned = !preset.pinned; if (!savePresets(presets)) return; renderPresetButtons(); closePresetMenu(); });
      menu.appendChild(item); anchor.appendChild(menu); openMenuEl=menu;
      menuTimer = setTimeout(()=> closePresetMenu(), 2500);
      menu.onmouseenter = ()=>{ if (menuTimer){ clearTimeout(menuTimer); menuTimer=null; } };
      menu.onmouseleave = ()=> closePresetMenu();
      document.addEventListener('click', closePresetMenu, { once: true });
    }

    // ===== ç¶­è­·ï¼šæ¸…ç†è‡ªæˆ‘æ¸¬è©¦æ®˜ç•™è³‡æ–™ =====
    function cleanupTestArtifacts(){
      if (!state.user) return;
      const shops = loadShops(); if (!Array.isArray(shops) || !shops.length) return;
      const removeIds = new Set(['shop__TEST__','shop_T14','shop_T19']);
      const filtered = shops.filter(s=> !removeIds.has(s.id) && !(s.name||'').startsWith('åº—T'));
      if (filtered.length !== shops.length){ saveShops(filtered);
        // åŒæ­¥åˆªé™¤å°æ‡‰æ–¹æ¡ˆ
        for (const s of shops){ if (!filtered.find(x=>x.id===s.id)){ const k = campsKey(s.id); if (k) localStorage.removeItem(k); } }
      }
    }

    // æ–°å¢æ¨£å¼ï¼ˆéœ€è¦ç™»å…¥ï¼‰
    els.presetAddBtn.addEventListener('click', ()=>{
      if (!state.user) { alert('è«‹å…ˆç™»å…¥å¸³è™Ÿæ‰èƒ½æ–°å¢æ¨£å¼'); return; }
      const name = (els.presetAddName.value||'').trim(); if (!name) { alert('è«‹è¼¸å…¥æ¨£å¼åç¨±'); return; }
      const preset = { id: uid(), name, pinned:false, settings: currentSettings() };
      presets.unshift(preset); if (!savePresets(presets)) return; els.presetAddName.value=''; renderPresetButtons();
    });

    function reloadPresets(){ presets = loadPresets(); renderPresetButtons(); updatePresetControls(); }

    function updatePresetControls(){
      const disabled = !state.user || !hasScopeReady();
      els.presetAddBtn.disabled = disabled; els.presetAddName.disabled = disabled;
      els.presetAddBtn.classList.toggle('opacity-50', disabled);
      els.presetAddBtn.classList.toggle('cursor-not-allowed', disabled);
    }

    // ===== é¡¯ç¤ºé …ç›®ï¼ˆå­˜å…¥ç•¶å‰æ–¹æ¡ˆ metaï¼‰ =====
    function loadDisplayOptionsFromMeta(){
      const meta = getActiveMeta();
      els.optShowShop.checked = !!meta.showShopName;
      els.optShowCamp.checked = !!meta.showCampaignName;
      els.optShowContact.checked = !!meta.showContact;
      els.optShowNotes.checked = !!meta.showNotes;
      els.optNotes.value = meta.notes || '';
      els.optShowBadge.checked = !!meta.showBadge;
      els.optBadgeText.value = meta.badgeText || 'é™æ™‚ç‰¹åƒ¹';
      if (els.optShowLogo) els.optShowLogo.checked = !!meta.showLogo;
      if (els.optShowQR) els.optShowQR.checked = meta.showQR !== false; // ç°¡åŒ–æ¢ä»¶ï¼Œé è¨­é¡¯ç¤º
      if (els.optBorderStyle) els.optBorderStyle.value = meta.borderStyle || 'none';
      if (els.optBorderColor) els.optBorderColor.value = meta.borderColor || '#e2e8f0';
      if (els.optBackgroundColor) els.optBackgroundColor.value = meta.backgroundColor || '#ffffff';
      els.optNotes.classList.toggle('hidden', !els.optShowNotes.checked);
    }

    function persistMeta(updater){
      if (!hasScopeReady()) return;
      const camps = loadCamps(state.selectedShopId);
      const idx = camps.findIndex(c=>c.id===state.selectedCampaignId);
      if (idx<0) return;
      const old = camps[idx];
      const next = { ...old, meta: { showShopName:true, showCampaignName:true, showContact:false, showNotes:false, notes:'', showBadge:false, badgeText:'é™æ™‚ç‰¹åƒ¹', showLogo:false, showQR:true, borderStyle:'none', borderColor:'#e2e8f0', backgroundColor:'#ffffff', ...(old.meta||{}) } };
      updater(next.meta);
      camps[idx] = next; saveCamps(state.selectedShopId, camps);
      renderDM();
    }

    ['change','input'].forEach(evt=>{
      els.optShowShop && els.optShowShop.addEventListener(evt, ()=> persistMeta(meta=> meta.showShopName = !!els.optShowShop.checked));
      els.optShowCamp && els.optShowCamp.addEventListener(evt, ()=> persistMeta(meta=> meta.showCampaignName = !!els.optShowCamp.checked));
      els.optShowContact && els.optShowContact.addEventListener(evt, ()=> persistMeta(meta=> meta.showContact = !!els.optShowContact.checked));
      els.optShowNotes && els.optShowNotes.addEventListener(evt, ()=>{ els.optNotes.classList.toggle('hidden', !els.optShowNotes.checked); persistMeta(meta=> meta.showNotes = !!els.optShowNotes.checked); });
      els.optNotes && els.optNotes.addEventListener('input', ()=> persistMeta(meta=> meta.notes = els.optNotes.value));
      els.optShowBadge && els.optShowBadge.addEventListener(evt, ()=> persistMeta(meta=> meta.showBadge = !!els.optShowBadge.checked));
      els.optShowLogo && els.optShowLogo.addEventListener(evt, ()=> persistMeta(meta=> meta.showLogo = !!els.optShowLogo.checked));
      els.optShowQR && els.optShowQR.addEventListener(evt, ()=> persistMeta(meta=> meta.showQR = !!els.optShowQR.checked));
      els.optBorderStyle && els.optBorderStyle.addEventListener(evt, ()=> persistMeta(meta=> meta.borderStyle = els.optBorderStyle.value));
      els.optBorderColor && els.optBorderColor.addEventListener(evt, ()=> persistMeta(meta=> meta.borderColor = els.optBorderColor.value));
      els.optBackgroundColor && els.optBackgroundColor.addEventListener(evt, ()=> persistMeta(meta=> meta.backgroundColor = els.optBackgroundColor.value));
      
      els.optBadgeText && els.optBadgeText.addEventListener('input', ()=> persistMeta(meta=> meta.badgeText = els.optBadgeText.value));
    });

    // ===== æ‰‹é¢¨ç´ =====
    const ACC_KEY_PREFIX = 'dm-acc-v1:'; // {userId}
    function accKey(){ return state.user ? ACC_KEY_PREFIX + state.user.id : null; }
    function loadAcc(){ const k=accKey(); if (!k) return {}; try{ return JSON.parse(localStorage.getItem(k)||'{}'); }catch{return{};} }
    function saveAcc(map){ const k=accKey(); if (!k) return; try{ localStorage.setItem(k, JSON.stringify(map)); }catch{} }

    function initAccordion(){
      const map = loadAcc();
      document.querySelectorAll('.acc').forEach(card=>{
        const key = card.getAttribute('data-acc-key')||'';
        const title = card.querySelector('.acc-title'); if (!title) return;
        const content = Array.from(card.children).filter(n=> n!==title);
        const expanded = key==='shop-camp' ? true : !!map[key];
        title.setAttribute('aria-expanded', expanded?'true':'false');
        content.forEach(n=> n.style.display = expanded? '' : 'none');
        title.addEventListener('click', (ev)=>{
          ev.preventDefault(); ev.stopPropagation();
          const isNowOpen = title.getAttribute('aria-expanded')==='true';
          const nextOpen = !isNowOpen;
          title.setAttribute('aria-expanded', nextOpen?'true':'false');
          content.forEach(n=> n.style.display = nextOpen? '' : 'none');
          const m = loadAcc(); m[key]=nextOpen; saveAcc(m);
        });
      });
    }

    function updateAccordionLock(){
      // é è¦½å€ä¸æ”¶åˆï¼›å…¶ä»–å·²ç”± initAccordion æ§åˆ¶
    }

    // ===== è‡ªæˆ‘æ¸¬è©¦ =====
    function runSelfTests(){
      const log = (ok, msg)=> (ok? console.log('âœ…',msg): console.error('âŒ',msg));
      log(!!els.dmCanvas && !!els.templateSelect && !!els.presetList, 'DOM å¿«å–å­˜åœ¨');
      const defs = loadPresets(); log(Array.isArray(defs) && defs.length>=4, 'é è¨­æ¨£å¼è¼‰å…¥ >=4');
      try { renderDM(); log(true,'renderDM æ­£å¸¸'); } catch(e){ log(false,'renderDM å¤±æ•—: '+e.message); }
      // æ¨¡æ“¬ç™»å…¥å¾Œæ–°å¢/åˆªé™¤ï¼ˆå»ºç«‹è‡¨æ™‚åº—å®¶èˆ‡æ–¹æ¡ˆä»¥ä¾¿å„²å­˜é è¨­ï¼‰
      const beforeUser = state.user; setUser({ id:'selftest@local', name:'SelfTest' });
      const shops0 = loadShops(); shops0.unshift({ id:'shop__TEST__', name:'æ¸¬è©¦åº—', logoDataUrl:'', brandColor:'#0ea5e9', contact:{} }); saveShops(shops0);
      state.selectedShopId = 'shop__TEST__';
      const camps0 = loadCamps('shop__TEST__'); camps0.unshift({ id:'camp__TEST__', name:'æ¸¬è©¦æª”æœŸ', settings: currentSettings(), meta:{} }); saveCamps('shop__TEST__', camps0);
      state.selectedCampaignId = 'camp__TEST__'; reloadPresets();
      const before = els.presetList.children.length;
      presets.unshift({ id:'__TEST__', name:'è‡ªæ¸¬', pinned:false, settings: currentSettings() }); savePresets(presets); renderPresetButtons();
      log(els.presetList.children.length === before+1, 'ç™»å…¥å¾Œæ–°å¢æ¨£å¼ +1');
      // æ¸¬è©¦ safeConfirm åœ¨ç„¡ confirm ç’°å¢ƒçš„ fallback
      const bk = window.confirm; window.confirm = undefined; const ok = safeConfirm('x'); log(ok===true, 'safeConfirm fallback ç‚º true'); window.confirm = bk;
      // åˆªé™¤å‰›å‰›æ–°å¢çš„
      presets = presets.filter(x=>x.id!=='__TEST__'); savePresets(presets); renderPresetButtons();
      log(els.presetList.children.length === before, 'åˆªé™¤æ¨£å¼ -1');
      // T-UI: é€é UI æŒ‰éˆ•åˆªé™¤éœ€å¯è¡Œ
      setUser({ id:'uitest@local', name:'UITest' }); reloadPresets();
      const uiPreset = { id:'__UI_DEL__', name:'UIåˆªé™¤', pinned:false, settings: currentSettings() };
      presets.unshift(uiPreset); savePresets(presets); renderPresetButtons();
      const btnDel = els.presetList.querySelector('[data-del="__UI_DEL__"]');
      if (btnDel) {
        btnDel.dispatchEvent(new Event('click', { bubbles:true }));
        const pop = btnDel.parentElement.querySelector('.del-pop[data-id="__UI_DEL__"]');
        if (pop) {
          const confirmBtn = pop.querySelector('[data-act="confirm"]');
          if (confirmBtn) confirmBtn.click();
        }
      }
      const existsAfter = !!presets.find(x=>x.id==='__UI_DEL__');
      log(existsAfter===false, 'UI åˆªé™¤æŒ‰éˆ•å¯åˆªé™¤æ¨£å¼');
      // é‚„åŸ
      setUser(beforeUser); reloadPresets();

      // ===== æ–°å¢æ¸¬è©¦ T13-T16 =====
      // T13ï¼šæœªé¸åº—+æ–¹æ¡ˆæ™‚ gating ç”Ÿæ•ˆ
      state.selectedShopId=null; state.selectedCampaignId=null; updateGating();
      const styleCard = els.templateSelect.closest('.bg-white');
      log(styleCard.classList.contains('pointer-events-none'), 'T13 æ¨£å¼å¡ disabled');
      log(els.downloadPng.disabled && els.downloadPdf.disabled, 'T13 åŒ¯å‡º disabled');
      // T14ï¼šæ–°å¢åº—å®¶å’Œæ–¹æ¡ˆå¾Œè§£é™¤é–å®š
      setUser({ id:'t14@local', name:'T14' });
      const sList = loadShops(); sList.unshift({ id:'shop_T14', name:'åº—T14', logoDataUrl:'', brandColor:'#0ea5e9', contact:{} }); saveShops(sList);
      state.selectedShopId='shop_T14';
      const cList = loadCamps('shop_T14'); cList.unshift({ id:'camp_T14', name:'æª”æœŸT14', settings: currentSettings(), meta:{} }); saveCamps('shop_T14', cList);
      state.selectedCampaignId='camp_T14'; updateGating();
      log(!els.downloadPng.disabled && !els.downloadPdf.disabled, 'T14 åŒ¯å‡ºè§£é–');
      // T15ï¼šå¥—ç”¨æ–¹æ¡ˆå¾Œ state èˆ‡ UI ä¸€è‡´
      const camp = findCampById('shop_T14','camp_T14'); applySettings({ ...camp.settings, imgFit:'contain' });
      log(state.imgFit==='contain' && els.fitSelect.value==='contain', 'T15 å¥—ç”¨æ–¹æ¡ˆåŒæ­¥');
      // T16ï¼šA/B æ–¹æ¡ˆé è¨­éš”é›¢
      const cList2 = loadCamps('shop_T14'); cList2.unshift({ id:'camp_T16B', name:'B', settings: currentSettings(), meta:{} }); saveCamps('shop_T14', cList2);
      state.selectedCampaignId='camp_T14'; reloadPresets(); const beforeCount = presets.length;
      presets.unshift({ id:'__A_ONLY__', name:'A only', pinned:false, settings: currentSettings() }); savePresets(presets);
      state.selectedCampaignId='camp_T16B'; reloadPresets(); const exists = !!presets.find(x=>x.id==='__A_ONLY__');
      log(exists===false, 'T16 A/B æ–¹æ¡ˆé è¨­éš”é›¢');

      // ===== T18-T21 æ‰‹é¢¨ç´èˆ‡é¡¯ç¤ºé …ç›® =====
      // T18 é è¨­æ”¶åˆï¼ˆæœªç™»å…¥æ™‚è·³éç‹€æ…‹ä¿å­˜æª¢æŸ¥ï¼‰
      const accCards = document.querySelectorAll('.acc');
      log(accCards.length>0, 'T18 å­˜åœ¨å¯æ”¶åˆå¡ç‰‡');
      // T19 é¡¯ç¤ºé¸é …åˆ‡æ›è§¸ç™¼ renderDM
      setUser({ id:'t19@local', name:'T19' });
      const sL = loadShops(); sL.unshift({ id:'shop_T19', name:'åº—T19', logoDataUrl:'', brandColor:'#0ea5e9', contact:{ phone:'0912-345-678' } }); saveShops(sL);
      state.selectedShopId='shop_T19';
      const cL = loadCamps('shop_T19'); cL.unshift({ id:'camp_T19', name:'æª”æœŸT19', settings: currentSettings(), meta:{ showShopName:true, showCampaignName:true, showContact:false, showNotes:false, notes:'' } }); saveCamps('shop_T19', cL);
      state.selectedCampaignId='camp_T19'; loadDisplayOptionsFromMeta();
      const beforeHTML = els.dmCanvas.innerHTML; els.optShowContact.checked = true; els.optShowContact.dispatchEvent(new Event('change')); const afterHTML = els.dmCanvas.innerHTML;
      log(beforeHTML !== afterHTML, 'T19 é¡¯ç¤ºè¯çµ¡æ–¹å¼è®Šæ›´æœƒåˆ·æ–°é è¦½');
      // T20 æ¸…ç©ºè¯çµ¡æ–¹å¼æ™‚æç¤º
      const shopsT19 = loadShops(); const sIdx = shopsT19.findIndex(x=>x.id==='shop_T19'); if (sIdx>=0){ shopsT19[sIdx].contact={}; saveShops(shopsT19); }
      renderDM(); log(els.dmCanvas.innerHTML.includes('å°šæœªå¡«åº—å®¶è¯çµ¡æ–¹å¼'), 'T20 ç©ºè¯çµ¡æ–¹å¼æœƒæœ‰æç¤º');
      // T21 åˆ‡æ›æ–¹æ¡ˆè¼‰å…¥ä¸åŒ meta
      const cL2 = loadCamps('shop_T19'); cL2.unshift({ id:'camp_T21', name:'B', settings: currentSettings(), meta:{ showShopName:false, showCampaignName:false, showContact:false, showNotes:true, notes:'B notes' } }); saveCamps('shop_T19', cL2);
      state.selectedCampaignId='camp_T21'; loadDisplayOptionsFromMeta(); renderDM();
      log(els.dmCanvas.innerHTML.includes('B notes'), 'T21 åˆ‡æ›æ–¹æ¡ˆè¼‰å…¥ notes');

      // ===== æ–°ç‰ˆé©—è­‰ =====
      // é è¨­æ¨¡æ¿ grid9
      log(state.template==='grid9', 'é è¨­æ¨¡æ¿ç‚ºä¹å®®æ ¼');
      // å•†å“åº«è¡¨é ­å…¨é¸å­˜åœ¨
      log(!!document.getElementById('select-all'), 'å•†å“åº«æœ‰å…¨é¸å‹¾é¸');
      // åˆ†é æª¢æŸ¥
      const backupP = [...state.products];
      while(state.products.length<11){ state.products.push({ id: uid(), name:'æ¸¬è©¦å“', price:1, originalPrice:'', desc:'', imageDataUrl:'' }); }
      state.selection = new Set(state.products.map(p=>p.id));
      state.template='grid9'; renderDM();
      log(els.dmCanvas.children.length>=2, 'ä¹å®®æ ¼ >9 ä»¶æœƒåˆ†é ');
      state.template='list'; renderDM(); log(els.dmCanvas.children.length>=1, 'æ¸…å–®å¯æ¸²æŸ“å¤šé ');
      state.template='single'; renderDM(); log(els.dmCanvas.children.length>=1, 'å–®å“å¯åˆ†é ');
      // é¡¯ç¤º QR æ——æ¨™
      const cTmp = findCampById('shop_T14','camp_T14'); if (cTmp){ cTmp.meta.qrDataUrl = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAE0lEQVR4nGNgYGD4z0AEYBxVAAAnLQH3qXb4+gAAAABJRU5ErkJggg=='; cTmp.meta.showQR = true; saveCamps('shop_T14', loadCamps('shop_T14')); state.selectedShopId='shop_T14'; state.selectedCampaignId='camp_T14'; loadDisplayOptionsFromMeta(); renderDM(); log(true,'é¡¯ç¤ºQRæ——æ¨™å¯è¼‰å…¥'); }
      // å¾½ç« ä¸é‡è¤‡
      state.template='single'; renderDM();
      const badgeCount = (els.dmCanvas.innerHTML.match(/é™æ™‚ç‰¹åƒ¹/g)||[]).length; log(badgeCount<=1, 'ä¿ƒéŠ·å¾½ç« ä¸é‡è¤‡');
      // é‚„åŸ
      state.products = backupP; state.selection = new Set(); state.template='grid9'; renderDM();
    }

    // ===== åˆå§‹åŒ– =====
    (function init(){
      // Demo å•†å“
      const demo = [
        { name:'æ‰‹ä½œé»‘ç³–ç²‰åœ“é®®å¥¶ 1L', price:129, originalPrice:159, desc:'é™é‡æ‰‹ç‚’é»‘ç³–ï¼Œé¦™æ¿ƒQå½ˆã€‚', imageDataUrl:'' },
        { name:'ä½æº«æ°£ç‚¸é›ç±³èŠ± 500g', price:99, originalPrice:'', desc:'æ°£ç‚¸ 8 åˆ†é˜å³å¯ä¸Šæ¡Œã€‚', imageDataUrl:'' },
        { name:'å°è¾²ç„¡æ¯’ç‰›ç•ªèŒ„ 2 æ–¤', price:120, originalPrice:160, desc:'ç”œä¸­å¸¶é…¸ï¼Œæ²™æ‹‰å¿…å‚™ã€‚', imageDataUrl:'' },
        { name:'äº”èŠ±åšåˆ‡ç‡’è‚‰ç‰‡ 600g', price:159, originalPrice:199, desc:'éœ²ç‡Ÿç‡’çƒ¤ç¥éšŠå‹ã€‚', imageDataUrl:'' },
        { name:'åšç‰‡èœ‚èœœåå¸ 6 ç‰‡', price:65, originalPrice:'', desc:'æ—©é¤çœæ™‚åˆå¥½åƒã€‚', imageDataUrl:'' },
      ];
      for (const d of demo) state.products.push({ id: uid(), ...d });

      renderShopPills(); renderCampaignPills(); renderChosenSummary(); updateGating(); initAccordion();
      reloadPresets(); updatePresetControls(); renderTable(); renderDM(); applyScale();
      runSelfTests();
      
    })();
  })();
  </script>
</body>
</html>
